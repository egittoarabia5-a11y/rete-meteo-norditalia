<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Mappa Meteo Genova</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@500&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/justgage/1.6.1/justgage.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
 


  <style>
    @font-face {
      font-family: 'Inter';
      src: 
           url('fonts/Inter.woff') format('woff');
      font-weight: 400 700;
      font-display: swap;
    }
    body {
      margin: 0;
      font-family: "Inter", sans-serif;
    }
    #menu {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: white;
      padding: 8px 12px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    #map {
      height: 100vh;
      width: 100%;
    }
    .circle-label {
  color: white;
  border-radius: 50%;
  font-weight: 450;
  font-size: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: "Inter", sans-serif;
  width: 25px;
  height: 25px;
  line-height: 1;           /* assicurati che non ci siano spazi extra */
  text-align: center;
}

    .circle-label2 {
      color: white;
      border-radius: 50%;
      font-weight: 0;
      font-size: 0px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: "Inter", sans-serif;
      width: 0px;
      height: 0px;
    }
  </style>
</head>
<body>
  <div id="sourceMenu" style="position:absolute; top:10px; right:10px; z-index:1000; background:white; padding:8px 12px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.2); font-size:14px;">
    <b>Fonti:</b><br>
    <label><input type="checkbox" class="sourceFilter" value="LIMET" > LIMET</label><br>
    <label><input type="checkbox" class="sourceFilter" value="TorinoMeteo" > TorinoMeteo</label><br>
    <label><input type="checkbox" class="sourceFilter" value="3R" > Meteo3R</label><br>
    <label><input type="checkbox" class="sourceFilter" value="Wunderground"> Wunderground</label><br>
    <label><input type="checkbox" class="sourceFilter" value="CentroMeteoLombardo"> CML</label><br>
    <label><input type="checkbox" class="sourceFilter" value="NetAtmo"> NetAtmo</label><br>
    <label><input type="checkbox" class="sourceFilter" value="DatiMeteoAsti"> DMA</label><br>
    <label><input type="checkbox" class="sourceFilter" value="OMIRL"> OMIRL</label>
  </div>
  
  
  <div id="menu">
    <label for="tempSelect"><b>Dati:</b></label>
    <select id="tempSelect">
      <option value="current">Temperatura</option>
      <option value="max">T Max</option>
      <option value="min">T Min</option>
      <option value="dewpt">Dewpoint</option>
      <option value="dewpMax">Dp Max</option>
      <option value="dewpMin">Dp Min</option>
      <option value="Heat">Heat Index</option>
      <option value="HeatMax">Ht Max</option>
      <option value="HeatMin">Ht Min</option>
      <option value="hum">Umidità</option>
      <option value="humMax">UR Max</option>
      <option value="humMin">UR Min</option>
      <option value="rainDay">Pioggia 24h</option>
      <option value="rainRate">Rain Rate</option>
      <option value="wind">Vento</option>
      <option value="winddirection">Direzione</option>
      <option value="windGust">Raffica</option>
      <option value="windGustMax">Raffica Max</option>

    </select>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // ----- Configurazione Mappa -----
    const map = L.map('map').setView([44.423, 8.972], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // ----- API Key -----
    const apiKey = 'e1f10a1e78da46f5b10a1e78da96f525';

    // ----- Lista Stazioni -----
    const stationsBest = {
      
  IGENOA58: { api: "IGENOA58" },
  IBARGAGL5: { api: "IBARGAGL5" },
  IBOGLI8: { api: "IBOGLI8" },
  IDAVAG2: { api: "IDAVAG2" },
  ITORRI4: { api: "ITORRI4" },
  IMONTO47: { api: "IMONTO47" },
  IGENOA3078: { api: "IGENOA2728" },
  IGENOA2767: { api: "IGENOA2767" },
  IGENOA2775: { api: "IGENOA2775" },
  IGENOA2800: { api: "IGENOA2800" },
  IGENOA2819: { api: "IGENOA2819" },
  IGENOA2833: { api: "IGENOA2833" },
  IGENOA2841: { api: "IGENOA2841" },
  IGENOA2843: { api: "IGENOA2843" },
  IGENOA2846: { api: "IGENOA2846" },
  IGENOA2857: { api: "IGENOA2857" },
  IGENOA2865: { api: "IGENOA2865" },
  IGENOA2881: { api: "IGENOA2881" },
  IGENOA2887: { api: "IGENOA2887" },
  IGENOA2895: { api: "IGENOA2895" },
  IGENOA2933: { api: "IGENOA2933" },
  IGENOA2959: { api: "IGENOA2959" },
  IGENOA2962: { api: "IGENOA2962" },
  IGENOA2970: { api: "IGENOA2970" },
  IGENOA2971: { api: "IGENOA2971" },
  IGENOA2980: { api: "IGENOA2980" },
  IGENOA2983: { api: "IGENOA2983" },
  IGENOA2984: { api: "IGENOA2984" },
  IGENOA2987: { api: "IGENOA2987" },
  IGENOA2991: { api: "IGENOA2991" },
  IGENOA2997: { api: "IGENOA2997" },
  IGENOA3005: { api: "IGENOA3005" },
  IGENOA3007: { api: "IGENOA3007" },
  IGENOA3019: { api: "IGENOA3019" },
  IGENOA3021: { api: "IGENOA3021" },
  IGENOA3032: { api: "IGENOA3032" },
  IGENOA3035: { api: "IGENOA3035" },
  IGENOA3052: { api: "IGENOA3052" },
  IGENOA3058: { api: "IGENOA3058" },
  IGENOA3069: { api: "IGENOA3069" },
  IGENOA3085: { api: "IGENOA3085" },
  IGENOA3101: { api: "IGENOA3101" },
  IGENOA2763: { api: "IGENOA2763" },
  IGENOA3027: { api: "IGENOA3027" },
  ILIGURIA67: { api: "ILIGURIA67" },
  IGENOA3104: { api: "IGENOA3104" },
  IGENOA2831: { api: "IGENOA2831" },
  IGENOA3041: { api: "IGENOA3041" },
  IGENOA2960: { api: "IGENOA2960" },
  IGENOA2969: { api: "IGENOA2969" },
  IGENOA3077: { api: "IGENOA3077" },
  IGENOVAA2: { api: "IGENOVAA2" },
  IGENOVAN1: { api: "IGENOVAN1" },
  IBOGLI8: { api: "IBOGLI8" },
  IBOGLI12: { api: "IBOGLI12" },
  IPIEVE46: { api: "IPIEVE46" },
  IGENOA2870: { api: "IGENOA2870" },
  IGENOA3055: { api: "IGENOA3055" },
  IGENOA3082: { api: "IGENOA3082" },
  IGENOA61: { api: "IGENOA61" },
};

    const stations = {
  IACQUI10: { api: "IACQUI10", nome: "Acqui Terme" }, 
  IALBAR21: { api: "IALBAR21", nome: "Albareto" },
  IBEDON8: { api: "IBEDON8", nome: "Bedonia" },
  IITALIA8: { api: "IITALIA8", nome: "Montevaca" },
  IALBAR26: { api: "IALBAR26", nome: "Albareto" },
  IBORGO129: { api: "IBORGO129", nome: "Borgo Val di Taro" },
  IACQUI19: { api: "IACQUI19", nome: "Acqui Terme" },
  IBISTA1: { api: "IBISTA1", nome: "Bistagno" },
  IBUBBI1: { api: "IBUBBI1", nome: "Bubbio" },
  ICANEL29: { api: "ICANEL29", nome: "Canelli" },
  IAGLIA8: { api: "IAGLIA8" },
  ICOSTI5: { api: "ICOSTI5", nome: "Costigliole d'Asti" },
  ICOSTI9: { api: "ICOSTI9", nome: "Costigliole d'Asti" },
  ICOSTI13: { api: "ICOSTI13", nome: "Costigliole d'Asti" },
  ICOSTI16: { api: "ICOSTI16", nome: "Costigliole d'Asti" },
  ICOSTI18: { api: "ICOSTI18", nome: "Costigliole d'Asti" },
  IALASS4: { api: "IALASS4", nome: "Alassio" },
  IALBA46: { api: "IALBA46", nome: "Alba" },
  IALBEN12: { api: "IALBEN12", nome: "Albenga" },
  IALBEN13: { api: "IALBEN13", nome: "Albenga" },
  IALBIS15: { api: "IALBIS15", nome: "Albisola" },
  IALBIS17: { api: "IALBIS17", nome: "Albisola" },
  IALESS19: { api: "IALESS19", nome: "Alessandria" },
  IALESS20: { api: "IALESS20", nome: "Alessandria" },
  IALESS22: { api: "IALESS22", nome: "Alessandria" },
  IALLUV5: { api: "IALLUV5", nome: "Alluvioni" },
  IALTAR9: { api: "IALTAR9", nome: "Altare" },
  IANDOR36: { api: "IANDOR36", nome: "Andora" },
  IANDOR38: { api: "IANDOR38", nome: "Andora" },
  IANDOR45: { api: "IANDOR45", nome: "Andora" },
  ICALIZ2: { api: "ICALIZ2", nome: "Calizzano" },
  IPIETR53: { api: "IPIETR53" },
  IMARMO9: { api: "IMARMO9" },
  ICASTE724: { api: "ICASTE724" },
  IOSTAN1: { api: "IOSTAN1" },
  IBAGNO61: { api: "IBAGNO61" },
  IPRALI9: { api: "IPRALI9", nome: "Prali" },
  IPRALI3: { api: "IPRALI3", nome: "Prali" },
  ISESTR42: { api: "ISESTR42", nome: "Sestriere" },
  ISAUZE2: { api: "ISAUZE2", nome: "Sauze d'Oulx" },
  IBELLI49: { api: "IBELLI49", nome: "Acqui Terme" },
  IARCOL18: { api: "IARCOL18" },
  IARNAS13: { api: "IARNAS13" },
  IASTI37: { api: "IASTI37", nome: "Asti" },
  IASTI39: { api: "IASTI39", nome: "Asti" },
  IASTI54: { api: "IASTI54", nome: "Asti" },
  IBAGNA27: { api: "IBAGNA27" },
  IBALDI160: { api: "IBALDI160" },
  IBARGAGL5: { api: "IBARGAGL5", nome: "Bargagli" },
  IBEINE9: { api: "IBEINE9", nome: "Beinette" },
  IBOGLI8: { api: "IBOGLI8", nome: "Bogliasco" },
  IBONAS9: { api: "IBONAS9", nome: "Bonassola" },
  IBORGO125: { api: "IBORGO125" },
  IBORGH21: { api: "IBORGH21", nome: "Borghetto S.Spirito" },
  IBOVES17: { api: "IBOVES17", nome: "Boves" },
  IBOVES27: { api: "IBOVES27", nome: "Boves" },
  IBOVES31: { api: "IBOVES31", nome: "Boves" },
  IBOZZO4: { api: "IBOZZO4" },
  IBRA535:  { api: "IBRA535", nome: "Bra" },
  IBRALL2: { api: "IBRALL2", nome: "Brallo" },
  IBRIGA11: { api: "IBRIGA11", nome: "Briga" },
  IBRIGA19: { api: "IBRIGA19", nome: "Briga" },
  IBRUGN23: { api: "IBRUGN23", nome: "Brugnato" },
  IBUSAL1: { api: "IBUSAL1", nome: "Busalla" },
  IBUSAL3: { api: "IBUSAL3", nome: "Busalla" },
  IBUTTI12: { api: "IBUTTI12" },
  ICAIRO36: { api: "ICAIRO36", nome: "Cairo Montenotte" },
  ICAIROMO3: { api: "ICAIROMO3", nome: "Cairo Montenotte" },
  ICAMER8: { api: "ICAMER8", nome: "Camerana" },
  ICAMPO219: { api: "ICAMPO219", nome: "Campo Ligure" },
  ICAMPOMO4: { api: "ICAMPOMO4", nome: "Campomorone" },
  ICAPANNO16: { api: "ICAPANNO16" },
  ICASSA19: { api: "ICASSA19" },
  ICASTE229: { api: "ICASTE229" },
  ICASTE241: { api: "ICASTE241" },
  ICASTE932: { api: "ICASTE932" },
  ICALIC1_: { api: "ICALIC1" },
  ICALIC3: { api: "ICALIC3" },
  ICALIZ13: { api: "ICALIZ13", nome: "Calizzano" },
  ICALOS1: { api: "ICALOS1" },
  ICAMOG7: { api: "ICAMOG7", nome: "Camogli" },
  ICAMPO57: { api: "ICAMPO57" },
  ICARAS1: { api: "ICARAS1", nome: "Rivarola" },
  ICARAS4: { api: "ICARAS4", nome: "Carasco Loreto" },
  ICARBO36: { api: "ICARBO36" },
  ICARIG15: { api: "ICARIG15" },
  ICARMA33: { api: "ICARMA33", nome: "Carmagnola" },
  ICARMA35: { api: "ICARMA35", nome: "Carmagnola" },
  ICARRA91: { api: "ICARRA91", nome: "Carrara" },
  ICARRO37: { api: "ICARRO37", nome: "Carrodano" },
  ICASAL53: { api: "ICASAL53" },
  ICASAL85: { api: "ICASAL85" },
  ICASAR73: { api: "ICASAR73" },
  ICASEL6: { api: "ICASEL6", nome: "Casella" },
  ICASSI26: { api: "ICASSI26" },
  ICASTE241: { api: "ICASTE241" },
  ICASTE560: { api: "ICASTE560" },
  ICASTE1086: { api: "ICASTE1086" },
  ICASTI67: { api: "ICASTI67" },
  ICENGI4: { api: "ICENGI4", nome: "Cengio" },
  ICENTA4: { api: "ICENTA4" },
  ICERAN6: { api: "ICERAN6", nome: "Ceranesi" },
  ICERES22: { api: "ICERES22", nome: "Ceres" },
  ICERIA1: { api: "ICERIA1", nome: "Ceriale" },
  ICESSO17: { api: "ICESSO17" },
  ICEVA7: { api: "ICEVA7", nome: "Ceva" },
  ICHERA3: { api: "ICHERA3", nome: "Cherasco" },
  ICHERA4: { api: "ICHERA4", nome: "Cherasco" },
  ICHERA5: { api: "ICHERA5", nome: "Cherasco" },
  ICHIAV1: { api: "ICHIAV1", nome: "Chiavari Caperana" },
  ICHIAV4: { api: "ICHIAV4", nome: "Chiavari Viale A.E.Devoto" },
  ICHIAV7: { api: "ICHIAV7", nome: "Chiavari" },
  ICHIAV11: { api: "ICHIAV11", nome: "Chiavari Ri Alto" },
  ICHIAV12: { api: "ICHIAV12", nome: "Chiavari" },
  ICHIAV14: { api: "ICHIAV14", nome: "Chiavari Corso C.Colombo" },
  ICHIUS13: { api: "ICHIUS13", nome: "Chiusa di Pesio" },
  ICHIUS15: { api: "ICHIUS15", nome: "Chiusa di Pesio" },
  ICICAG1: { api: "ICICAG1", nome: "Cicagna" },
  ICOGOL7: { api: "ICOGOL7", nome: "Cogoleto" },
  ICOGOL47: { api: "ICOGOL47", nome: "Cogoleto" },
  ICOGOL52: { api: "ICOGOL52", nome: "Cogoleto" },
  ICOGOR6: { api: "ICOGOR6", nome: "San Salvatore" },
  ICORTE57: { api: "ICORTE57", nome: "Cortemilia" },
  ICREMO15: { api: "ICREMO15", nome: "Cremolino" },
  ICROCE7: { api: "ICROCE7", nome: "Crocefieschi" },
  IDAVAG2: { api: "IDAVAG2", nome: "Davagna" },
  IDIANO12: { api: "IDIANO12", nome: "Diano Marina" },
  IDOLCE9: { api: "IDOLCE9" },
  IDOGLI1: { api: "IDOGLI1" },
  IDERNI2: { api: "IDERNI2" },
  IDUSIN1: { api: "IDUSIN1", nome: "Dusino San Michele" },
  IFABBR5: { api: "IFABBR5", nome: "Fabbriche" },
  IFARIG1: { api: "IFARIG1" },
  IFERRIER5: { api: "IFERRIER5", nome: "Ferriere" },
  IFILIG4: { api: "IFILIG4" },
  IFOLLO7: { api: "IFOLLO7" },
  IFINAL12: { api: "IFINAL12", nome: "Finale Ligure" },
  IFOSSA15: { api: "IFOSSA15", nome: "Fossano" },
  IFOSSANO8: { api: "IFOSSANO8", nome: "Fossano" },
  IGAMAL1: { api: "IGAMAL1" },
  IGARES3: { api: "IGARES3", nome: "Garessio" },
  IGAVI6: { api: "IGAVI6", nome: "Gavi" },
  IGAVI7: { api: "IGAVI7", nome: "Gavi" },
  IGENOA58: { api: "IGENOA58", nome: "Genova Multedo" },
  IGENOA3078: { api: "IGENOA2728" },
  IGENOA2767: { api: "IGENOA2767" },
  IGENOA2800: { api: "IGENOA2800" },
  IGENOA2819: { api: "IGENOA2819" },
  IGENOA2833: { api: "IGENOA2833" },
  IGENOA2841: { api: "IGENOA2841" },
  IGENOA2843: { api: "IGENOA2843" },
  IGENOA2846: { api: "IGENOA2846" },
  IGENOA2857: { api: "IGENOA2857" },
  IGENOA2865: { api: "IGENOA2865" },
  IGENOA2881: { api: "IGENOA2881" },
  IGENOA2870: { api: "IGENOA2870" },
  IGENOA3055: { api: "IGENOA3055" },
  IGENOA2887: { api: "IGENOA2887" },
  IGENOA2895: { api: "IGENOA2895" },
  IGENOA2933: { api: "IGENOA2933" },
  IGENOA2959: { api: "IGENOA2959" },
  IGENOA2960: { api: "IGENOA2960" },
  IGENOA2962: { api: "IGENOA2962" },
  IGENOA2969: { api: "IGENOA2969" },
  IGENOA2970: { api: "IGENOA2970" },
  IGENOA2971: { api: "IGENOA2971" },
  IGENOA2980: { api: "IGENOA2980" },
  IGENOA2983: { api: "IGENOA2983" },
  IGENOA2984: { api: "IGENOA2984" },
  IGENOA2987: { api: "IGENOA2987" },
  IGENOA2991: { api: "IGENOA2991" },
  IGENOA2997: { api: "IGENOA2997" },
  IGENOA3005: { api: "IGENOA3005" },
  IGENOA3007: { api: "IGENOA3007" },
  IGENOA3019: { api: "IGENOA3019" },
  IGENOA3021: { api: "IGENOA3021" },
  IGENOA3032: { api: "IGENOA3032" },
  IGENOA3035: { api: "IGENOA3035" },
  IGENOA3052: { api: "IGENOA3052" },
  IGENOA3058: { api: "IGENOA3058" },
  IGENOA3069: { api: "IGENOA3069" },
  IGENOA3077: { api: "IGENOA3077" },
  IGENOA3085: { api: "IGENOA3085" },
  IGENOA3104: { api: "IGENOA3104" },
  IGENOA2831: { api: "IGENOA2831" },
  IGENOA3041: { api: "IGENOA3041" },
  IGENOA3082: { api: "IGENOA3082" },
  IGENOA2947: { api: "IGENOA2947" },
  IGENOA2830: { api: "IGENOA2830" },
  IGENOA2861: { api: "IGENOA2861" },
  IGENOA3012: { api: "IGENOA3012" },
  IGENOA3056: { api: "IGENOA3056" },
  IGENOA2748: { api: "IGENOA2748" },
  IGENOA2903: { api: "IGENOA2903" },
  IGENOA2795: { api: "IGENOA2795" },
  IGENOA60: { api: "IGENOA60" },
  ILIGURIA24: { api: "ILIGURIA24" },
  IGENOA2892: { api: "IGENOA2892" },
  IGENOA46: { api: "IGENOA46" },
  IGENOA2929: { api: "IGENOA2929" },
  IGENOVAG3: { api: "IGENOVAG3" },
  IGENOA2728: { api: "IGENOA2728" },
  IGENOA3026: { api: "IGENOA3026" },
  IGENOA2948: { api: "IGENOA2948" },
  IGENOA2968: { api: "IGENOA2968" },
  IGENOA3018: { api: "IGENOA3018" },
  IGENOA2804: { api: "IGENOA2804" },
  IGENOVAA2: { api: "IGENOVAA2" },
  IGENOVAN1: { api: "IGENOVAN1" },
  IBOGLI12: { api: "IBOGLI12", nome: "Bogliasco" },
  IPIEVE46: { api: "IPIEVE46", nome: "Pieve Ligure" },
  IGROND1: { api: "IGROND1", nome: "Grondona" },
  IISOLA59: { api: "IISOLA59" },
  IISOLDA1: { api: "IISOLDA1", nome: "Soldano" },
  ILAIGU19: { api: "ILAIGU19", nome: "Laigueglia" },
  ILERIC8: { api: "ILERIC8", nome: "Lerici" },
  ILEQUI3: { api: "ILEQUI3", nome: "Lequio Berria" },
  ILEVAN16: { api: "ILEVAN16", nome: "Levanto" },
  ILIGURIA2: { api: "ILIGURIA2", nome: "Genova Quezzi Bassa" },
  ILIGURIA20: { api: "ILIGURIA20", nome: "Moneglia" },
  ILIGURIA51: { api: "ILIGURIA51", nome: "Sori" },
  ILIGURIA88: { api: "ILIGURIA88" },
  ILIGURIA123: { api: "ILIGURIA123", nome: "Villa Oneto" },
  ILIGURIA175: { api: "ILIGURIA175", nome: "Lavagna" },
  ILIGURIA181: { api: "ILIGURIA181" },
  ILIGURIA186: { api: "ILIGURIA186" },
  ILIMON9: { api: "ILIMON9", nome: "Limonetto 1400" },
  ILIMON17: { api: "ILIMON17", nome: "Limone Piemonte" },
  ILIMON19: { api: "ILIMON19", nome: "Limone Piemonte" },
  ILOMBARD405: { api: "ILOMBARD405" },
  ILGFORNA4: { api: "ILGFORNA4" },
  ILUCCA69: { api: "ILUCCA69", nome: "Lucca" },
  ILUCIN14: { api: "ILUCIN14" },
  IMACCA6: { api: "IMACCA6", nome: "Maccagno" },
  IMALLA14: { api: "IMALLA14", nome: "Mallare" },
  IMASON4: { api: "IMASON4", nome: "Masone" },
  IMASON6: { api: "IMASON6", nome: "Masone" },
  IMASSA43: { api: "IMASSA43", nome: "Massa" },
  IMEDE8: { api: "IMEDE8", nome: "Mede" },
  IMELE15: { api: "IMELE15", nome: "Mele" },
  IMELE16_: { api: "IMELE16", nome: "Mele" },
  IMENDA13: { api: "IMENDA13", nome: "Mendatica" },
  IMENDA14: { api: "IMENDA14", nome: "Mendatica" },
  IMERAN2: { api: "IMERAN2", nome: "Merano" },
  IMIGNA23: { api: "IMIGNA23", nome: "Mignanego" },
  IMILLE3: { api: "IMILLE3", nome: "Millesimo" },
  IMOCON1: { api: "IMOCON1", nome: "Moconesi" },
  IMOLAR2: { api: "IMOLAR2", nome: "Molare" },
  IMONEG33: { api: "IMONEG33", nome: "Moneglia" },
  IMONGI4: { api: "IMONGI4", nome: "Mongiardino Ligure" },
  IMONTA172: { api: "IMONTA172", nome: "Montaldo" },
  IMONTE1010: { api: "IMONTE1010", nome: "Montegrosso" },
  IMONTO93: { api: "IMONTO93", nome: "Casà" },
  IMORSA15: { api: "IMORSA15", nome: "Morsasco" },
  IMONFO5: { api: "IMONFO5", nome: "Monforte" },
  IMONTO47: { api: "IMONTO47", nome: "Montoggio" },
  IMURAZ6: { api: "IMURAZ6", nome: "Murazzano" },
  IMURIALD2: { api: "IMURIALD2", nome: "Murialdo" },
  INEIRO1: { api: "INEIRO1", nome: "Neirone" },
  INEIRO2: { api: "INEIRO2", nome: "Neirone" },
  INEIVE1: { api: "INEIVE1", nome: "Neive" },
  INOVEL23: { api: "INOVEL23", nome: "Novello" },
  INOVIL12: { api: "INOVIL12", nome: "Novi Ligure" },
  INOVIL17: { api: "INOVIL17", nome: "Novi Ligure" },
  INOVIL34: { api: "INOVIL34", nome: "Novi Ligure" },
  INOVILIG13: { api: "INOVILIG13", nome: "Novi Ligure" },
  IONZO2: { api: "IONZO2", nome: "Onzo" },
  IORMEA3: { api: "IORMEA3", nome: "Ormea" },
  IORMEA11: { api: "IORMEA11", nome: "Ormea" },
  IOTTON1: { api: "IOTTON1", nome: "Ottone" },
  IOTTON2: { api: "IOTTON2", nome: "Ottone" },
  IORTOV1: { api: "IORTOV1", nome: "Ortovero" },
  IORSAR1: { api: "IORSAR1", nome: "San Quirico" },
  IOVADA9: { api: "IOVADA9", nome: "Ovada" },
  IOVADA12: { api: "IOVADA12", nome: "Ovada" },
  IPAVIA9: { api: "IPAVIA9", nome: "Pavia" },
  IPAVIA24: { api: "IPAVIA24", nome: "Pavia" },
  IPAVIA42: { api: "IPAVIA42", nome: "Pavia" },
  IPEVER4: { api: "IPEVER4", nome: "Peveragno" },
  IPIEA6: { api: "IPIEA6", nome: "Piea" },
  IPIEMONT238: { api: "IPIEMONT238", nome: "Cortandone" },
  IPIETR8: { api: "IPIETR8", nome: "Pietra Ligure" },
  IPIEVE47: { api: "IPIEVE47", nome: "Pieve Ligure" },
  IPOIRI2: { api: "IPOIRI2", nome: "Poirini" },
  IPONZO6: { api: "IPONZO6", nome: "Ponzone" },
  IPONZO9: { api: "IPONZO9", nome: "Ponzone" },
  IPMVILLA8: { api: "IPMVILLA8" },
  IPRASC3: { api: "IPRASC3", nome: "Prasco" },
  IRAPAL3: { api: "IRAPAL3", nome: "Rapallo Sant'Agostino" },
  IRAPAL8: { api: "IRAPAL8", nome: "Rapallo Stazione" },
  IRAPAL15: { api: "IRAPAL15", nome: "Rapallo" },
  IRAPAL21: { api: "IRAPAL21", nome: "Rapallo San Massimo" },
  IRAPAL26: { api: "IRAPAL26", nome: "Rapallo" },
  IRAPAL28: { api: "IRAPAL28", nome: "Rapallo Golf" },
  IRAPAL29: { api: "IRAPAL29", nome: "Rapallo" },
  IRAPAL30: { api: "IRAPAL30", nome: "Rapallo Via Betti" },
  IRAPAL33: { api: "IRAPAL33", nome: "Rapallo" },
  IRAPAL34: { api: "IRAPAL34", nome: "Rapallo Salita S.Agostino" },
  IRECCO4: { api: "IRECCO4", nome: "Recco Uscita A12" },
  IRIALT2: { api: "IRIALT2" },
  IRICCD2: { api: "IRICCD2", nome: "Riccò del Golfo" },
  IRIVAP3: { api: "IRIVAP3" },
  IROATT2: { api: "IROATT2" },
  IROCCA35: { api: "IROCCA35" },
  IROCCA37: { api: "IROCCA37" },
  IROCCA49: { api: "IROCCA49" },
  IROCCA172: { api: "IROCCA172" },
  IRODEL3: { api: "IRODEL3" },
  IRODDI4: { api: "IRODDI4" },
  IRONCO16: { api: "IRONCO16" },
  IRONCO23: { api: "IRONCO23" },
  IRONCO30: { api: "IRONCO30" },
  IROSSI9: { api: "IROSSI9" },
  IROVEG2: { api: "IROVEG2" },
  ISANBE44: { api: "ISANBE44" },
  ISANCR61: { api: "ISANCR61" },
  ISANDA4: { api: "ISANDA4" },
  ISANDA45: { api: "ISANDA45" },
  ISANFR79: { api: "ISANFR79" },
  ISANGI194: { api: "ISANGI194" },
  ISANMA94: { api: "ISANMA94" },
  ISANPA4: { api: "ISANPA4" },
  ISANRE10: { api: "ISANRE10" },
  ISANRE25: { api: "ISANRE25" },
  ISANRE52: { api: "ISANRE52" },
  ISANTA737: { api: "ISANTA737" },
  ISANTA1095: { api: "ISANTA1095" },
  ISANTA1316: { api: "ISANTA1316" },
  ISANTA1419: { api: "ISANTA1419" },
  ISANTA1669: { api: "ISANTA1669" },
  ISANTA2003: { api: "ISANTA2003", nome: "Santa Margherita Ligure Crosa dell'Oro" },
  ISANTE63: { api: "ISANTE63" },
  ISANTO233: { api: "ISANTO233" },
  ISANTO347: { api: "ISANTO347" },
  ISANTO411: { api: "ISANTO411" },
  ISARZA7: { api: "ISARZA7" },
  ISARZA25: { api: "ISARZA25" },
  ISAVIG25: { api: "ISAVIG25" },
  ISAVIG93: { api: "ISAVIG93" },
  ISAVON38: { api: "ISAVON38" },
  ISAVONA11: { api: "ISAVONA11" },
  ISAVONAL1: { api: "ISAVONAL1" },
  ISESSA22: { api: "ISESSA22" },
  ISESTR23: { api: "ISESTR23" },
  ISESTR28: { api: "ISESTR28" },
  ISESTR36: { api: "ISESTR36" },
  ISERRA21: { api: "ISERRA21" },
  ISERRA22: { api: "ISERRA22" },
  ISERRA75: { api: "ISERRA75" },
  ISERRA86: { api: "ISERRA86" },
  ISERRA88: { api: "ISERRA88" },
  ISILVA16: { api: "ISILVA16" },
  ISORI12: { api: "ISORI12" },
  ISPINE11: { api: "ISPINE11" },
  ISPIGN2: { api: "ISPIGN2" },
  ISPOTO4: { api: "ISPOTO4" },
  ISTAZZAN2: { api: "ISTAZZAN2" },
  ISTAZZ9: { api: "ISTAZZ9" },
  ISTAZZ13: { api: "ISTAZZ13" },
  ISTELL21: { api: "ISTELL21" },
  ITASSA1: { api: "ITASSA1" },
  ITESTI1: { api: "ITESTI1" },
  ITOSCANA56: { api: "ITOSCANA56" },
  ITOSCANA135: { api: "ITOSCANA135" },
  ITORRE444: { api: "ITORRE444" },
  ITORRI4: { api: "ITORRI4" },
  ITORRI20: { api: "ITORRI20" },
  ITORRI54: { api: "ITORRI54" },
  ITORTO104: { api: "ITORTO104" },
  ITRIBO2: { api: "ITRIBO2" },
  IURBE3: { api: "IURBE3" },
  IURBE10: { api: "IURBE10" },
  IVADOL4: { api: "IVADOL4" },
  IVALBR3: { api: "IVALBR3" },
  IVALBR4: { api: "IVALBR4" },
  IVALDI75: { api: "IVALDI75" },
  IVALLE94: { api: "IVALLE94" },
  IVARAZ2: { api: "IVARAZ2" },
  IVARAZ6: { api: "IVARAZ6" },
  IVARAZ9: { api: "IVARAZ9" },
  IVARZI7: { api: "IVARZI7" },
  IVENTI16: { api: "IVENTI16" },
  IVERNA8: { api: "IVERNA8" },
  IVERRU5: { api: "IVERRU5" },
  IVEZZI1_: { api: "IVEZZI1" },
  IVIARE23: { api: "IVIARE23" },
  IVILLA352: { api: "IVILLA352" },
  IVILLA764: { api: "IVILLA764" },
  IVILLA1061: { api: "IVILLA1061" },
  IVILLA1125: { api: "IVILLA1125" },
  IVILLA1686: { api: "IVILLA1686" },
  IVILLA1819: { api: "IVILLA1819" },
  IVOGHE6: { api: "IVOGHE6" },
  IVOLTA3: { api: "IVOLTA3" },
  IVOLTA7: { api: "IVOLTA7" },
  IZIGNA2: { api: "IZIGNA2" },
  ILALOG2: { api: "ILALOG2" },
  ITROFA24: { api: "ITROFA24" },
  ITONICHE1: { api: "ITONICHE1" },
  IVOLVE3: { api: "IVOLVE3" },
  IVIGON12: { api: "IVIGON12" },
  IVIRLE1: { api: "IVIRLE1" },
  IZOAGL7: { api: "IZOAGL7", nome: "Sant'Ambrogio della Costa" },
  IGENOA3101: { api: "IGENOA3101" },
  IGENOA2763: { api: "IGENOA2763" },
  ILIGURIA67: { api: "ILIGURIA67" },
  IZUCCA2: { api: "IZUCCA2" },
  ICARRO18: { api: "ICARRO18" },
  IBORGH19: { api: "IBORGH19" },
  IRICCD1: { api: "IRICCD1" },
  ILASPE54: { api: "ILASPE54" },
  IPODEN7: { api: "IPODEN7" },
  IBOLAN4: { api: "IBOLAN4" },
  IAULLA13: { api: "IAULLA13" },
  ISANTO122: { api: "ISANTO122" },
  ISESTR27: { api: "ISESTR27" },
  ICHIAV18: { api: "ICHIAV18" },
  ILAVAG25: { api: "ILAVAG25" },
  ILAVAG28: { api: "ILAVAG28" },
  IPISA68: { api: "IPISA68" },
  ILIVOR77: { api: "ILIVOR77" },
  ILIVOR44: { api: "ILIVOR44" },
  IROSIG33: { api: "IROSIG33" },
  IROSIG55: { api: "IROSIG55" },
  ICASTE621: { api: "ICASTE621" },
  ICASTA86: { api: "ICASTA86" },
  IPIOMB27: { api: "IPIOMB27" },
  IPIOMB32: { api: "IPIOMB32" },
  ICAMPI72: { api: "ICAMPI72" },
  IPIOMB19: { api: "IPIOMB19" },
  IPORTO350: { api: "IPORTO350" },
  ICAMPO382: { api: "ICAMPO382" },
  IPIETR31: { api: "IPIETR31" },
  IFORTE35: { api: "IFORTE35" },
  ICAMAI18: { api: "ICAMAI18" },
  IVIARE22: { api: "IVIARE22" },
  IPISA55: { api: "IPISA55" },
  IPISA66: { api: "IPISA66" },
  ICASCI45: { api: "ICASCI45" },
  ILIVOR90: { api: "ILIVOR90" },
  ILIVOR65: { api: "ILIVOR65" },
  IFAUGLIA5: { api: "IFAUGLIA5" },
  ICAMAI23: { api: "ICAMAI23" },
  IPESCA65: { api: "IPESCA65" },
  IPESCA30: { api: "IPESCA30" },
  IBORGO8: { api: "IBORGO8" },
  IBARGA6: { api: "IBARGA6" },
  IBARGA21: { api: "IBARGA21" },
  IGALLI34: { api: "IGALLI34" },
  ISCARLIN2: { api: "ISCARLIN2" },
  ICASTI181: { api: "ICASTI181" },
  IGROSS76: { api: "IGROSS76" },
  IGROSS24: { api: "IGROSS24" },
  IGROSS49: { api: "IGROSS49" },
  IGROSS81: { api: "IGROSS81" },
  IGROSS79: { api: "IGROSS79" },
  IMAGLI36: { api: "IMAGLI36" },
  ICASTI124: { api: "ICASTI124" },
  IGAVOR3: { api: "IGAVOR3" },
  ITOSCANA114: { api: "ITOSCANA114" },
  ICAMPA38: { api: "ICAMPA38" },
  IBAGNA36: { api: "IBAGNA36" },
  ISCAGN2: { api: "ISCAGN2" },
  IVICOF8: { api: "IVICOF8" },
  IVICOF5: { api: "IVICOF5" },
  IROCCA98: { api: "IROCCA98" },
  IROCCA101: { api: "IROCCA101" },
  IROCCA9: { api: "IROCCA9" },
  IDEMON2: { api: "IDEMON2" },
  IBORGO63: { api: "IBORGO63" },
  IVIGNO11: { api: "IVIGNO11" },
  ICUNEO23: { api: "ICUNEO23" },
  ICUNEO15: { api: "ICUNEO15" },
  IVALGR2: { api: "IVALGR2" },
  IBERNE82: { api: "IBERNE82" },
  ICERVA10: { api: "ICERVA10" },
  ICERVA15: { api: "ICERVA15" },
  ICARAG5: { api: "ICARAG5" },
  IDRONE3: { api: "IDRONE3" },
  IDRONE2: { api: "IDRONE2" },
  IDRONE4: { api: "IDRONE4" },
  IROCCA71: { api: "IROCCA71" },
  IVILLA505: { api: "IVILLA505" },
  IVILLA924: { api: "IVILLA924" },
  IBUSCA8: { api: "IBUSCA8" },
  IPIASC1: { api: "IPIASC1" },
  IRIFRE2: { api: "IRIFRE2" },
  IENVIE3: { api: "IENVIE3" },
  IREVEL60: { api: "IREVEL60" },
  IPRALI4: { api: "IPRALI4" },
  IFENES3: { api: "IFENES3" },
  IROURE1: { api: "IROURE1" },
  IPERRE12: { api: "IPERRE12" },
  IPEROS1: { api: "IPEROS1" },
  IPMPONTE5: { api: "IPMPONTE5" },
  ICHIOM4: { api: "ICHIOM4" },
  IBARDO23: { api: "IBARDO23" },
  IBARDO27: { api: "IBARDO27" },
  IBARDO16: { api: "IBARDO16" },
  IOULX4: { api: "IOULX4" },
  IOULX5: { api: "IOULX5" },
  ISALBE1: { api: "ISALBE1" },
  IGIAGL1: { api: "IGIAGL1" },
  INOVAL8: { api: "INOVAL8" },
  IMONCENI2: { api: "IMONCENI2" },
  IMOMPA3: { api: "IMOMPA3" },
  IMOMPANT2: { api: "IMOMPANT2" },
  IMATTI3: { api: "IMATTI3" },
  IBUSSO14: { api: "IBUSSO14" },
  IBUSSO5: { api: "IBUSSO5" },
  ICHIAN5: { api: "ICHIAN5" },
  IBRUZO2: { api: "IBRUZO2" },
  ISANGI141: { api: "ISANGI141" },
  ICONDO30: { api: "ICONDO30" },
  IVILLA1146: { api: "IVILLA1146" },
  IVILLA220: { api: "IVILLA220" },
  IVILLA774: { api: "IVILLA774" },
  ISANTA993: { api: "ISANTA993" },
  ICONDO19: { api: "ICONDO19" },
  ICONDO26: { api: "ICONDO26" },
  ISANTA614: { api: "ISANTA614" },
  ILUINO13: { api: "ILUINO13" },
  IDUMEN2: { api: "IDUMEN2" },
  ILUINO15: { api: "ILUINO15" },
  ILUINO6: { api: "ILUINO6" },
  IBREZZ4: { api: "IBREZZ4" },
  ILAVEN14: { api: "ILAVEN14" },
  IMESEN3: { api: "IMESEN3" },
  ICASSA35: { api: "ICASSA35" },
  ITAMBR10: { api: "ITAMBR10" },
  IPRAMO8: { api: "IPRAMO8" },
  IPINAS3: { api: "IPINAS3" },
  IPINAS5: { api: "IPINAS5" },
  IVILLA1673: { api: "IVILLA1673" },
  IPIEMONT258: { api: "IPIEMONT258" },
  IPRARO1: { api: "IPRARO1" },
  IPINER91: { api: "IPINER91" },
  IPINER30: { api: "IPINER30" },
  ISANPI32: { api: "ISANPI32" },
  ITORINOP2: { api: "ITORINOP2" },
  IPINER90: { api: "IPINER90" },
  IPINER67: { api: "IPINER67" },
  IPINEROL19: { api: "IPINEROL19" },
  IBURIA1: { api: "IBURIA1" },
  IFROSS1: { api: "IFROSS1" },
  IPISCI4: { api: "IPISCI4" },
  IVOLVE4: { api: "IVOLVE4" },
  ICAVOU1: { api: "ICAVOU1" },
  IBIRCH9: { api: "IBIRCH9" },
  IVILLARP8: { api: "IVILLARP8" },
  ITORREPE3: { api: "ITORREPE3" },
  IANGRO6: { api: "IANGRO6" },
  IROR3: { api: "IROR3" },
  IBARGE18: { api: "IBARGE18" },
  IBAGNO63: { api: "IBAGNO63" },
  IBIBIA2: { api: "IBIBIA2" },
  IENVIE4: { api: "IENVIE4" },
  ISCARN3: { api: "ISCARN3" },
  IPIOSS5: { api: "IPIOSS5" },
  IRIVAL15: { api: "IRIVAL15" },
  ITRANA3: { api: "ITRANA3" },
  IGIAVE3: { api: "IGIAVE3" },
  IPMGIAVE6: { api: "IPMGIAVE6" },
  ICOAZZ6: { api: "ICOAZZ6" },
  ICOAZZ4: { api: "ICOAZZ4" },
  IAVIGL6: { api: "IAVIGL6" },
  IRIVAL6: { api: "IRIVAL6" },
  IRIVOL16: { api: "IRIVOL16" },
  IALMES4: { api: "IALMES4" },
  IROSTA7: { api: "IROSTA7" },
  ICOLLE151: { api: "ICOLLE151" },
  IGIVOL2: { api: "IGIVOL2" },
  ILACAS8: { api: "ILACAS8" },
  IVENAR2: { api: "IVENAR2" },
  INOLE6: { api: "INOLE6" },
  IVALLO8: { api: "IVALLO8" },
  IBALAN8: { api: "IBALAN8" },
  ICORIO4: { api: "ICORIO4" },
  IGERMA4: { api: "IGERMA4" },
  ICANTO12: { api: "ICANTO12" },
  ICERES14: { api: "ICERES14" },
  IALADI3: { api: "IALADI3" },
  IALADI1: { api: "IALADI1" },
  IRHMES1: { api: "IRHMES1" },
  ICOURM10: { api: "ICOURM10" },
  ICOURM3: { api: "ICOURM3" },
  IOLLOM2: { api: "IOLLOM2" },
  IVALTO2: { api: "IVALTO2" },
  IBORGO131: { api: "IBORGO131" },
  IEMILIAR181: { api: "IEMILIAR181" },
  IPALAN9: { api: "IPALAN9" },
  IFARIN10: { api: "IFARIN10" },
  IBETTO1: { api: "IBETTO1" },
  IBETTO20: { api: "IBETTO20" },
  ITRAVO6: { api: "ITRAVO6" },
  IROMAG9: { api: "IROMAG9" },
  IZAVAT1: { api: "IZAVAT1" },
  IALTAV16: { api: "IALTAV16" },
  IGOLFE1: { api: "IGOLFE1" },
  ICASTA79: { api: "ICASTA79" },
  ISTRADADEL11: { api: "ISTRADADEL11" },
  IBORGO59: { api: "IBORGO59" },
  ICAMBI25: { api: "ICAMBI25" },
  IMONCA21: { api: "IMONCA21" },
  IPINOT4: { api: "IPINOT4" },
  ICHIER3: { api: "ICHIER3" },
  IBALDI142: { api: "IBALDI142" },
  IARIGN3: { api: "IARIGN3" },
  ISANMA95: { api: "ISANMA95" },
  ISCIOL3: { api: "ISCIOL3" },
  IRIVALBA2: { api: "IRIVALBA2" },
  ISETTI13: { api: "ISETTI13" },
  IBORGA47: { api: "IBORGA47" },
  ILEINI4: { api: "ILEINI4" },
  IVOLPI4: { api: "IVOLPI4" },
  ISANFR59: { api: "ISANFR59" },
  ICORIO8: { api: "ICORIO8" },
  IPIEMONT87: { api: "IPIEMONT87" },
  ICUORG4: { api: "ICUORG4" },
  IRIVAR15: { api: "IRIVAR15" },
  IFAVRI2: { api: "IFAVRI2" },
  ISANGI197: { api: "ISANGI197" },
  ICUCEG2: { api: "ICUCEG2" },
  ILORAN1: { api: "ILORAN1" },
  IPIEMONT121: { api: "IPIEMONT121" },
  IIVREA9: { api: "IIVREA9" },
  ITOSETTI2: { api: "ITOSETTI2" },
  IBROSS5: { api: "IBROSS5" },
  IPIEMONT169: { api: "IPIEMONT169" },
  IPONTS3: { api: "IPONTS3" },
  IPERLO3: { api: "IPERLO3" },
  IVALLEDA4: { api: "IVALLEDA4" },
  IGRESS20: { api: "IGRESS20" },
  ICHAMP172: { api: "ICHAMP172" },
  IMONTJ17: { api: "IMONTJ17" },
  IMONTJOV2: { api: "IMONTJOV2" },
  ISAINT4791: { api: "ISAINT4791" },
  IAYAS5: { api: "IAYAS5" },
  IAYAS13: { api: "IAYAS13" },
  ICHTIL24: { api: "ICHTIL24" },
  IAOSTACH2: { api: "IAOSTACH2" },
  IANTEY1: { api: "IANTEY1" },
  ITORGN6: { api: "ITORGN6" },
  IANTEY3: { api: "IANTEY3" },
  ICHAMO9: { api: "ICHAMO9" },
  IVALTO7: { api: "IVALTO7" },
  ICHAMB79: { api: "ICHAMB79" },
  IVERRA2: { api: "IVERRA2" },
  IVALLEDA19: { api: "IVALLEDA19" },
  ISAINT482: { api: "ISAINT482" },
  IPROVI59: { api: "IPROVI59" },
  IGRESS24: { api: "IGRESS24" },
  ISARRE7: { api: "ISARRE7" },
  ICHARV6: { api: "ICHARV6" },
  ICHARV4: { api: "ICHARV4" },
  IGRESS6: { api: "IGRESS6" },
  ISAINT8985: { api: "ISAINT8985" },
  IMORGE4: { api: "IMORGE4" },
  ILATHU2: { api: "ILATHU2" },
  ILATHU10: { api: "ILATHU10" },
  ICOURM3: { api: "ICOURM3" },
  IINTRO3: { api: "IINTRO3" },
  IDONAT4: { api: "IDONAT4" },
  INETRO2: { api: "INETRO2" },
  IZUBIE1: { api: "IZUBIE1" },
  IMONGR1: { api: "IMONGR1" },
  IDONAT3: { api: "IDONAT3" },
  IDONAT6: { api: "IDONAT6" },
  ISALUS1: { api: "ISALUS1" },
  ISORDEVO2: { api: "ISORDEVO2" },
  IPOLLO1: { api: "IPOLLO1" },
  IBIELL11: { api: "IBIELL11" },
  IBIELL8: { api: "IBIELL8" },
  IPIEMONT126: { api: "IPIEMONT126" },
  ICAMPI93: { api: "ICAMPI93" },
  ITAVIG7: { api: "ITAVIG7" },
  IBIOGL1: { api: "IBIOGL1" },
  IBIOGL2: { api: "IBIOGL2" },
  IVALDI62: { api: "IVALDI62" },
  IPORTU23: { api: "IPORTU23" },
  ICURIN10: { api: "ICURIN10" },
  ICURIN9: { api: "ICURIN9" },
  ISOSTE1: { api: "ISOSTE1" },
  ILOZZOLO2: { api: "ILOZZOLO2" },
  IGATTINA2: { api: "IGATTINA2" },
  IROMAG19: { api: "IROMAG19" },
  IBORGO135: { api: "IBORGO135" },
  IBORGO29: { api: "IBORGO29" },
  IVARAL2: { api: "IVARAL2" },
  ISCOPA3: { api: "ISCOPA3" },
  IPIEMONT250: { api: "IPIEMONT250" },
  IPIEMONT251: { api: "IPIEMONT251" },
  IALAGN11: { api: "IALAGN11" },
  IALAGN5: { api: "IALAGN5" },
  IBORGO17: { api: "IBORGO17" },
  ICUREG3: { api: "ICUREG3" },
  IGOZZA3: { api: "IGOZZA3" },
  IPOGNO1: { api: "IPOGNO1" },
  IAROLA5: { api: "IAROLA5" },
  IOMEGN5: { api: "IOMEGN5" },
  IPETTE12: { api: "IPETTE12" },
  IARMEN5: { api: "IARMEN5" },
  IVALST3: { api: "IVALST3" },
  IGRAVE48: { api: "IGRAVE48" },
  IPREMO5: { api: "IPREMO5" },
  IPIEDI10: { api: "IPIEDI10" },
  IBANNI6: { api: "IBANNI6" },
  IVILLA1613: { api: "IVILLA1613" },
  IDOMOD11: { api: "IDOMOD11" },
  ICREVO4: { api: "ICREVO4" },
  IDOMOD18: { api: "IDOMOD18" },
  ITOCEN1: { api: "ITOCEN1" },
  IMALES2: { api: "IMALES2" },
  IVARZO3: { api: "IVARZO3" },
  IVARZO2: { api: "IVARZO2" },
  IFORMA3: { api: "IFORMA3" },
  ICAMBI27: { api: "ICAMBI27" },
  IVERBA25: { api: "IVERBA25" },
  IVERBA24: { api: "IVERBA24" },
  IOGGEB4: { api: "IOGGEB4" },
  ICANNO4: { api: "ICANNO4" },
  ICANNO18: { api: "ICANNO18" },
  IMACCA15: { api: "IMACCA15" },
  ICALUS9: { api: "ICALUS9" },
  IVISCH1: { api: "IVISCH1" },
  IMERCE2: { api: "IMERCE2" },
  IROPPO1: { api: "IROPPO1" },
  IPIVER4: { api: "IPIVER4" },
  ISANDI20: { api: "ISANDI20" },
  ICANDE45: { api: "ICANDE45" },
  IGIFFLEN2: { api: "IGIFFLEN2" },
  ICOSSA55: { api: "ICOSSA55" },
  ICARPI27: { api: "ICARPI27" },
  IGHEMM1: { api: "IGHEMM1" },
  IBAREN12: { api: "IBAREN12" },
  IBAVEN2: { api: "IBAVEN2" },
  ISTRES7: { api: "ISTRES7" },
  IBROVE3: { api: "IBROVE3" },
  IBELGI1: { api: "IBELGI1" },
  ILESA28: { api: "ILESA28" },
  INEBBI2: { api: "INEBBI2" },
  IOLEGG6: { api: "IOLEGG6" },
  ICOMIG1: { api: "ICOMIG1" },
  IPIEMONT132: { api: "IPIEMONT132" },
  IBORGO80: { api: "IBORGO80" },
  ICUREG4: { api: "ICUREG4" },
  IGARGA19: { api: "IGARGA19" },
  IBORGO108: { api: "IBORGO108" },
  IAGRAT15: { api: "IAGRAT15" },
  IAGRAT13: { api: "IAGRAT13" },
  IMEZZO14: { api: "IMEZZO14" },
  IVAPRI6: { api: "IVAPRI6" },
  ICALTIGN3: { api: "ICALTIGN3" },
  ICASAL31: { api: "ICASAL31" },
  ISANPI40: { api: "ISANPI40" },
  ICAMER16: { api: "ICAMER16" },
  IGALLI7: { api: "IGALLI7" },
  ITRECA15: { api: "ITRECA15" },
  IGALLI10: { api: "IGALLI10" },
  IBERNATE2: { api: "IBERNATE2" },
  ICASTA3: { api: "ICASTA3" },
  ILONAT3: { api: "ILONAT3" },
  ILOMBARD227: { api: "ILOMBARD227" },
  IMEZZO16: { api: "IMEZZO16" },
  IBELLINZ47: { api: "IBELLINZ47" },
  IGALLA20: { api: "IGALLA20" },
  IGALLA28: { api: "IGALLA28" },
  ICASSA30: { api: "ICASSA30" },
  IVARESEC3: { api: "IVARESEC3" },
  IBESNA2: { api: "IBESNA2" },
  IBESNA3: { api: "IBESNA3" },
  IVERGI8: { api: "IVERGI8" },
  IPIEMONT69: { api: "IPIEMONT69" },
  ISESTO12: { api: "ISESTO12" },
  ISESTO36: { api: "ISESTO36" },
  ILAMBRUSC2: { api: "ILAMBRUSC2" },
  ITAINO2: { api: "ITAINO2" },
  IANGER73: { api: "IANGER73" },
  IISPRA10: { api: "IISPRA10" },
  IISPRA7: { api: "IISPRA7" },
  ITRAVE36: { api: "ITRAVE36" },
  IMONVA3: { api: "IMONVA3" },
  IBESOZ4: { api: "IBESOZ4" },
  IVARESEB1: { api: "IVARESEB1" },
  IBESOZ3: { api: "IBESOZ3" },
  ILOMBARD79: { api: "ILOMBARD79" },
  IGEMON12: { api: "IGEMON12" },
  ILAVEN7: { api: "ILAVEN7" },
  ILAVEN16: { api: "ILAVEN16" },
  ILEGGI2: { api: "ILEGGI2" },
  ILAVENOM13: { api: "ILAVENOM13" },
  ICASTE362: { api: "ICASTE362" },
  ICASTE1092: { api: "ICASTE1092" },
  ICITTI1: { api: "ICITTI1" },
  ICASAL54: { api: "ICASAL54" },
  IAZZIO1: { api: "IAZZIO1" },
  ICASTE564: { api: "ICASTE564" },
  IPORTA205: { api: "IPORTA205" },
  IASTI24: { api: "IASTI24" },
  ICASTA37: { api: "ICASTA37" },
  ILU5: { api: "ILU5" },
  IFUBIN1: { api: "IFUBIN1" },
  IALTAV9: { api: "IALTAV9" },
  ICAMAG1: { api: "ICAMAG1" },
  IROSIG24: { api: "IROSIG24" },
  ISANGI186: { api: "ISANGI186" },
  ICASALEM1135: { api: "ICASALEM1135" },
  ICASAL17: { api: "ICASAL17" },
  ICASAL90: { api: "ICASAL90" },
  ISTROPPI2: { api: "ISTROPPI2" },
  IASIGL1: { api: "IASIGL1" },
  IVERCE2: { api: "IVERCE2" },
  ICASALIN2: { api: "ICASALIN2" },
  ICONFI7: { api: "ICONFI7" },
  ICASAL38: { api: "ICASAL38" },
  ISANPI34: { api: "ISANPI34" },
  INOVAR29: { api: "INOVAR29" },
  INOVAR9: { api: "INOVAR9" },
  INOVAR10: { api: "INOVAR10" },
  INOVAR19: { api: "INOVAR19" },
  ITERDO1: { api: "ITERDO1" },
  IROBBI2: { api: "IROBBI2" },
  ICILAV1: { api: "ICILAV1" },
  IMORTA17: { api: "IMORTA17" },
  ICASTE892: { api: "ICASTE892" },
  IPORTA126: { api: "IPORTA126" },
  ICALLI82: { api: "ICALLI82" },
  IPONZA11: { api: "IPONZA11" },
  IOTTIG17: { api: "IOTTIG17" },
  IGRAZZ4: { api: "IGRAZZ4" },
  ICALLIAN12: { api: "ICALLIAN12" },
  ICALLI66: { api: "ICALLI66" },
  ICASTE729: { api: "ICASTE729" },
  ICAMER10: { api: "ICAMER10" },
  IPIEMONT58: { api: "IPIEMONT58" },
  IMONTI121: { api: "IMONTI121" },
  ISOLON8: { api: "ISOLON8" },
  ISOLON1: { api: "ISOLON1" },
  IVILLA493: { api: "IVILLA493" },
  IPROZO1: { api: "IPROZO1" },
  IFONTA121: { api: "IFONTA121" },
  ITONEN1: { api: "ITONEN1" },
  ITORINOC5: { api: "ITORINOC5" },
  IARAME1: { api: "IARAME1" },
  ICASAL41: { api: "ICASAL41" },
  IVEROL7: { api: "IVEROL7" },
  ITORRA3: { api: "ITORRA3" },
  ICALUS1: { api: "ICALUS1" },
  ICHIVASS5: { api: "ICHIVASS5" },
  IRIVAL17: { api: "IRIVAL17" },
  ISCIOL2: { api: "ISCIOL2" },
  IGASSI7: { api: "IGASSI7" },
  ITURIN3182: { api: "ITURIN3182" },
  ITURIN3229: { api: "ITURIN3229" },
  ITURIN3198: { api: "ITURIN3198" },
  ITURIN3249: { api: "ITURIN3249" },
  ITURIN3193: { api: "ITURIN3193" },
  ITURIN3250: { api: "ITURIN3250" },
  ITURIN3266: { api: "ITURIN3266" },
  ITURIN3170: { api: "ITURIN3170" },
  ITURIN3276: { api: "ITURIN3276" },
  IBRUSI2: { api: "IBRUSI2" },
  IBRUSI1: { api: "IBRUSI1" },
  ICUASS1: { api: "ICUASS1" },
  IVARESEC5: { api: "IVARESEC5" },
  IBESAN18: { api: "IBESAN18" },
  ISALTR6: { api: "ISALTR6" },
  IVIGGI18: { api: "IVIGGI18" },
  IARCIS6: { api: "IARCIS6" },
  IINDUNOO6: { api: "IINDUNOO6" },
  IRONAG1: { api: "IRONAG1" },
  IUGGIA3: { api: "IUGGIA3" },
  IALBIO2: { api: "IALBIO2" },
  ISOLBI5: { api: "ISOLBI5" },
  IBINAG2: { api: "IBINAG2" },
  IVEDAN5: { api: "IVEDAN5" },
  ISANFE100: { api: "ISANFE100" },
  ICOMO54: { api: "ICOMO54" },
  IMASLI2: { api: "IMASLI2" },
  ICERNOBB13: { api: "ICERNOBB13" },
  ILOMBARD377: { api: "ILOMBARD377" },
  IMOLTR2: { api: "IMOLTR2" },
  ILAGLI2: { api: "ILAGLI2" },
  IDIZZA8: { api: "IDIZZA8" },
  ICENTR750: { api: "ICENTR750" },
  ICENTR787: { api: "ICENTR787" },
  IPONNA1: { api: "IPONNA1" },
  IALTAV22: { api: "IALTAV22" },
  IALTAV30: { api: "IALTAV30" },
  IALTAV17: { api: "IALTAV17" },
  IALTAV10: { api: "IALTAV10" },
  ISALAC11: { api: "ISALAC11" },
  IMENAG2: { api: "IMENAG2" },
  IPORLE1: { api: "IPORLE1" },
  ICARLA10: { api: "ICARLA10" },
  ISANSI5: { api: "ISANSI5" },
  ICREMI6: { api: "ICREMI6" },
  IPIANE12: { api: "IPIANE12" },
  IGERAL122: { api: "IGERAL122" },
  IGERAL99: { api: "IGERAL99" },
  ISORIC2: { api: "ISORIC2" },
  ISORIC4: { api: "ISORIC4" },
  IDUBIN6: { api: "IDUBIN6" },
  ISORIC5: { api: "ISORIC5" },
  INOVAT8: { api: "INOVAT8" },
  INOVAT10: { api: "INOVAT10" },
  IMESE3: { api: "IMESE3" },
  ISANGI202: { api: "ISANGI202" },
  ICAMPO129: { api: "ICAMPO129" },
  IVILLA1237: { api: "IVILLA1237" },
  IDELEB2: { api: "IDELEB2" },
  ITRAON2: { api: "ITRAON2" },
  IMELLO1: { api: "IMELLO1" },
  IARDEN33: { api: "IARDEN33" },
  IVALMASI2: { api: "IVALMASI2" },
  ICASTI120: { api: "ICASTI120" },
  ICAIOL2: { api: "ICAIOL2" },
  IOBJECTH4: { api: "IOBJECTH4" },
  ISONDR8: { api: "ISONDR8" },
  IMONTA244: { api: "IMONTA244" },
  IPIATEDA2: { api: "IPIATEDA2" },
  IPIATE4: { api: "IPIATE4" },
  ILANZA7: { api: "ILANZA7" },
  ILANZA6: { api: "ILANZA6" },
  ICHIUR7: { api: "ICHIUR7" },
  ITEGLI5: { api: "ITEGLI5" },
  ITEGLI6: { api: "ITEGLI6" },
  IBIANZ2: { api: "IBIANZ2" },
  IAPRIC10: { api: "IAPRIC10" },
  ISOTIRAN3: { api: "ISOTIRAN3" },
  ITIRANO3: { api: "ITIRANO3" },
  IVILLA996: { api: "IVILLA996" },
  ITIRAN7: { api: "ITIRAN7" },
  ISERNI3: { api: "ISERNI3" },
  ITOVOD1: { api: "ITOVOD1" },
  IVERVI23: { api: "IVERVI23" },
  IMONNO1: { api: "IMONNO1" },
  IGROSO6: { api: "IGROSO6" },
  IGROSI31: { api: "IGROSI31" },
  IGROSI38: { api: "IGROSI38" },
  ISONDA1: { api: "ISONDA1" },
  ISONDA4: { api: "ISONDA4" },
  ILOMBARD436: { api: "ILOMBARD436" },
  ILOMBARD331: { api: "ILOMBARD331" },
  IVALDI93: { api: "IVALDI93" },
  IVALDI41: { api: "IVALDI41" },
  IVALDI61: { api: "IVALDI61" },
  ILIVIG1: { api: "ILIVIG1" },
  IEDOLO3: { api: "IEDOLO3" },
  ITEM2: { api: "ITEM2" },
  IVIONE1: { api: "IVIONE1" },
  IPONTE22: { api: "IPONTE22" },
  IPONTE56: { api: "IPONTE56" },
  IPONTE101: { api: "IPONTE101" },
  IVERMI19: { api: "IVERMI19" },
  ISPIGN1: { api: "ISPIGN1" },
  IGENOA61: { api: "IGENOA61" },
  ISORI13: { api: "ISORI13" },
  IGENOA3093: { api: "IGENOA3093" },
  IRONCO17: { api: "IRONCO17" },
  IACQUI20: { api: "IACQUI20" },
  ISAREZ2: { api: "ISAREZ2" },
  IGENOVA3078: { api: "IGENOA3078" },
  ISESTR22: { api: "ISESTR22", nome: "Sestri L. Santa Sabina" },
  ISESTR34: { api: "ISESTR34", nome: "Sestri L. San Bernardo" },
  ISESTR34: { api: "ISESTR34", nome: "Sestri L. San Bernardo" },
};
const stationsNetAtmo = {};
const stations3R = {};
const stationsLimet = {};

const stations1 = {
  Favale: {
    link: "https://retelimet.centrometeoligure.it/stazioni/meteo-favale/data/wd/file/customclientraw.txt",
    lat: 44.453,
    lon: 9.260
  },
  
  // aggiungi qui altre stazioni Cumulus MX, ognuna con link/lat/lon
};
const stations3 = {
  Cogoleto: {
    link: "https://meteocogoleto.altervista.org/cumulus/websitedata.json?_=1755609287452",
    lat: 44.390,
    lon: 8.646
  },
  
  // aggiungi qui altre stazioni Cumulus MX, ognuna con link/lat/lon
};
const stations2 = {
  PoggioRovegno: {
    link: "https://www.turbolic.altervista.org/meteopoggio/cumulus/index.htm",
    lat: 44.570,
    lon: 9.279
  },
  // aggiungi qui altre stazioni Cumulus MX, ognuna con link/lat/lon
};
const stationsDMA =  {
};
const stationsCML = {};
const stationsMeteoTortona =  {
  Tortona: {
    link: "https://meteotortona.it/link/dettaglio_stazioni.php?stazione=tortona",
    lat: 44.897,            // latitudine
    lon: 8.863              // longitudine
  }, 
  Casale: {
    link: "https://meteotortona.it/link/dettaglio_stazioni.php?stazione=casale",
    lat: 45.137,            // latitudine
    lon: 8.449              // longitudine
  },
  Pozzolo: {
    link: "https://meteotortona.it/link/dettaglio_stazioni.php?stazione=pozzolo",
    lat: 44.791,            // latitudine
    lon: 8.784              // longitudine
  },
  CasaCabano: {
    link: "https://meteotortona.it/link/dettaglio_stazioni.php?stazione=casacabano",
    lat: 44.840,            // latitudine
    lon: 9.250              // longitudine
  },
  AlberaLigure: {
    link: "https://meteotortona.it/link/dettaglio_stazioni.php?stazione=albera",
    lat: 44.7,            // latitudine
    lon: 9.065              // longitudine
  },
  Daglio: {
    link: "https://meteotortona.it/link/dettaglio_stazioni.php?stazione=daglio",
    lat: 44.645,            // latitudine
    lon: 9.149              // longitudine
  },
  Cosola: {
    link: "https://meteotortona.it/link/dettaglio_stazioni.php?stazione=cosola",
    lat: 44.669,            // latitudine
    lon: 9.178              // longitudine
  },
}

const markers = {};
let latestData = {};


// ----- Colori Umidità -----
function getColorHum(hum) {
  if (hum >= 90.0) return "#0114F0"; 
  if (hum >= 80.0) return "#0060F0"; 
  if (hum >= 70.0) return "#00BDEF"; 
  if (hum >= 60.0) return "#21C2C5"; 
  if (hum >= 50.0) return "#21C573"; 
  if (hum >= 40.0) return "#3AA300"; 
  if (hum >= 30.0) return "#F0B800"; 
  if (hum >= 20.0) return "#F0CB00";
  if (hum >= 10.0) return "#F07D00";
  return "#F01E00"; 
}

// ----- Colori Pioggia -----
function getColorRain(rain) {
  if (rain >= 150.0) return "#843BEB"; 
  if (rain >= 100.0) return "#FF69B4";
  if (rain >= 50.0) return "#0038F0";
  if (rain >= 30.0) return "#4682B4"; 
  if (rain >= 20.0) return "#87CEEB";
  if (rain >= 10.0) return "#3AA300";
  if (rain >= 5.0) return "#006400";
  if (rain >= 0.2) return "#F09F00";
  return "#808080"; 
}

// ----- Colori Temperatura -----
function getColorTemp(temp) {
  if (temp >= 38.0) return "#843BEB";
  if (temp >= 35.0) return "#FF69B4";
  if (temp >= 30.0) return "#8B0000";
  if (temp >= 25.0) return "#FF0000";
  if (temp >= 20.0) return "#E67D00";
  if (temp >= 15.0) return "#E6B800";
  if (temp >= 11.0) return "#3AA300";
  if (temp >= 5.0) return "#006400";
  if (temp >= 0.0) return "#87CEEB";
  if (temp >= -5.0) return "#4682B4";
  if (temp >= -10.0) return "#0000FF";
  return "#191970";
}
function getColorWindDir(deg) {
  if (deg >= 0 && deg <= 360) return "#4682B4";
  return "#191970";
}

// ----- Cerca meta della stazione -----
function getStationMeta(id) {
  const maps = {
    stations, stationsLimet, stations3R, stationsTorinoMeteo,stationsNetAtmo,
    stationsOMIRL, stationsCML, stationsDMA, stationsMeteoTortona,
    stations1, stations2, stations3, stationsBest
  };

  const defaultSource = {
    stations: 'Wunderground',
    stationsNetAtmo: 'NetAtmo',
    stationsLimet: 'LIMET',
    stations3R: '3R',
    stationsTorinoMeteo: 'TorinoMeteo',
    stationsOMIRL: 'OMIRL',
    stationsCML: 'CentroMeteoLombardo',
    stationsDMA: 'DatiMeteoAsti',
    stationsMeteoTortona: 'MeteoTortona',
    stations1: 'LIMET1',
    stations2: 'LIMET2',
    stations3: 'LIMET3',
    stationsBest: 'Wunderground'
  };

  for (const key of Object.keys(maps)) {
    const map = maps[key];
    if (!map) continue;
    const meta = map[id];
    if (meta) {
      const source = meta.source || defaultSource[key] || 'unknown';
      const name = meta.name || meta.NOME || meta.denominazione || meta.DENOMINAZIONE || meta.slug || id;
      return { source, name, meta };
    }
  }

  // fallback
  return { source: 'unknown', name: id, meta: null };
}

// ----- Creazione Marker Responsivo -----
function createMarker(id, lat = 44.423, lon = 8.972) {
  const scale = Math.min(window.innerWidth / 1200, 1);
  const size = 20 * scale;

  const icon = L.divIcon({
    className: '',
    html: `<div class="circle-label2"
                 style="
                   width:${size}px;
                   height:${size}px;
                   border-radius:50%;
                   background-color:#808080;
                   border:1px solid #fff;
                 ">
           </div>`,
    iconSize: [size, size],
    iconAnchor: [size / 2, size / 2]
  });

  const marker = L.marker([lat, lon], { icon });
  marker.bindPopup(`<b>Stazione:</b> ${id}<br>⚠️ Offline`);
  markers[id] = marker;
}

// Aggiorna dimensione marker su resize
window.addEventListener("resize", () => {
  Object.keys(markers).forEach(id => {
    const m = markers[id];
    const latlng = m.getLatLng();
    map.removeLayer(m);
    createMarker(id, latlng.lat, latlng.lng);
  });
});

// ----- Converti gradi in direzione cardinale -----
function degToDir(deg) {
  if (deg == null) return "N/D";
  const dirs = ["N", "NE", "E", "SE", "S", "SW", "W", "NW"];
  return dirs[Math.floor(((deg + 22.5) % 360) / 45)];
}

// ----- Aggiorna Marker -----
function updateMarker(id) {
  const type = document.getElementById("tempSelect").value;
  const data = latestData[id];
  if (!data) return;

  let value = null;
  let color = null;

  // Valore e colore in base al tipo
  if (type === "winddirection") {
    value = data.windDir;
    color = data.windGust != null ? getColorRain(data.windGust) : "#808080";
  } else {
    switch(type) {
      case "current": value = data.temp; color = getColorTemp(value); break;
      case "max": value = data.tempHigh; color = getColorTemp(value); break;
      case "min": value = data.tempLow; color = getColorTemp(value); break;
      case "dewpt": value = data.dewp; color = getColorTemp(value); break;
      case "dewpMax": value = data.dewpHigh; color = getColorTemp(value); break;
      case "dewpMin": value = data.dewpLow; color = getColorTemp(value); break;
      case "Heat": value = data.heat; color = getColorTemp(value); break;
      case "HeatMax": value = data.heatHigh; color = getColorTemp(value); break;
      case "HeatMin": value = data.heatLow; color = getColorTemp(value); break;
      case "hum": value = data.hum; color = getColorHum(value); break;
      case "humMax": value = data.humHigh; color = getColorHum(value); break;
      case "humMin": value = data.humLow; color = getColorHum(value); break;
      case "rainDay": value = data.rainDaily; color = getColorRain(value); break;
      case "rainRate": value = data.rainRate; color = getColorRain(value); break;
      case "wind": value = data.wind; color = getColorRain(value); break;
      case "windGust": value = data.windGust; color = getColorRain(value); break;
      case "windGustMax": value = data.windGustHigh; color = getColorRain(value); break;
      default: value = null; color = null;
    }
  }

  // Crea o aggiorna marker
  const icon = value != null
    ? L.divIcon({
        className: '',
        html: `<div class="circle-label" style="background-color:${color}; border:2px solid white;">${value.toFixed(1)}</div>`,
        iconSize: [32, 32],
        iconAnchor: [16, 16]
      })
    : L.divIcon({
        className: '',
        html: `<div class="circle-label" style="background-color:#808080; width: 12px; height: 12px; border-radius: 50%;"></div>`,
        iconSize: [12, 12],
        iconAnchor: [6, 6]
      });

  if (!markers[id]) {
    markers[id] = L.marker([data.lat, data.lon], { icon }).addTo(map);
  } else {
    markers[id].setIcon(icon);
  }

  // Popup aggiornato
  const meta = getStationMeta(id);
  const stationSource = meta.source;
  const stationName = meta.name;

// costruiamo il popup
let popupContent = `<b>Stazione:</b> ${stationName}<br>`;
popupContent += `<b>Fonte:</b> ${stationSource}<br>`;
if (type.startsWith("current") || type.startsWith("max") || type.startsWith("min")) {
  popupContent += `🌡️ Attuale: ${data.temp != null ? data.temp.toFixed(1) : "N/D"}°C<br>`;
  popupContent += `🔺 Max: ${data.tempHigh != null ? data.tempHigh.toFixed(1) : "N/D"}°C<br>`;
  popupContent += `🔻 Min: ${data.tempLow != null ? data.tempLow.toFixed(1) : "N/D"}°C<br>`;
} else if (type.startsWith("dew")) {
  popupContent += `🌡️ Attuale: ${data.dewp != null ? data.dewp.toFixed(1) : "N/D"}°C<br>`;
} else if (type.startsWith("hum")) {
  popupContent += `💧 Attuale: ${data.hum != null ? data.hum.toFixed(1) : "N/D"}%<br>`;
} else if (type.startsWith("rain")) {
  popupContent += `🌧️ Pioggia giorno: ${data.rainDaily != null ? data.rainDaily.toFixed(1) : "N/D"} mm<br>`;
  popupContent += `💦 Rain rate: ${data.rainRate != null ? data.rainRate.toFixed(1) : "N/D"} mm/h<br>`;
} else if (type.startsWith("wind")) {
  popupContent += `💨 Velocità attuale: ${data.wind != null ? data.wind.toFixed(1) : "N/D"} km/h<br>`;
}

if (value == null) popupContent += "⚠️ Offline<br>";

// conversione del timestamp in ora di Roma
let timeStr = "N/D";
if (data.time) {
  const utcTime = new Date(data.time);
  const options = { timeZone: "Europe/Rome", hour12: false };
  const formatterDate = new Intl.DateTimeFormat("it-IT", { ...options, year: "numeric", month: "2-digit", day: "2-digit" });
  const formatterTime = new Intl.DateTimeFormat("it-IT", { ...options, hour: "2-digit", minute: "2-digit", second: "2-digit" });

  const [day, month, year] = formatterDate.format(utcTime).split("/");
  const [hours, minutes, seconds] = formatterTime.format(utcTime).split(":");

  timeStr = `${day}/${month}/${year} - ${hours}:${minutes}:${seconds}`;
}

popupContent += `⏰ Ultimo aggiornamento: ${timeStr}`;



const gaugesUrl = `gauges.html?station=${encodeURIComponent(id)}&source=${encodeURIComponent(stationSource)}&name=${encodeURIComponent(stationName)}`;
popupContent += `<button type="button" onclick="window.open('${gaugesUrl}', 'gaugesWindow')">📊 Gauges</button>`;

markers[id].setPopupContent(popupContent);


  // Aggiorna posizione
  if (data.lat && data.lon) markers[id].setLatLng([data.lat, data.lon]);
}

// ----- Gauges -----
function openGauges(stationId) {
  window.open(`gauges.html?station=${stationId}`, "_blank", "width=420,height=600");
}

// ----- Filtro Marker -----
function filterMarkersBySource() {
  const checked = Array.from(document.querySelectorAll('.sourceFilter:checked')).map(cb => cb.value);
  Object.keys(markers).forEach(id => {
    const meta = getStationMeta(id);
    if (!meta) return;
    const source = meta.source;
    if (checked.includes(source)) {
      markers[id].addTo(map);
    } else {
      map.removeLayer(markers[id]);
    }
  });
}

document.querySelectorAll('.sourceFilter').forEach(cb => {
  cb.addEventListener('change', filterMarkersBySource);
});




async function fetchLimet() {
  try {
    const url = "https://api-stazioni-meteo.vercel.app/limet.json";
    const res = await fetch(url);
    const text = await res.text();

    const lines = text.trim().split("\n");
    if (lines.length < 2) return;

    // prima riga: timestamp originale ISO
    const timestampObj = JSON.parse(lines[0]);
    const originalTimestamp = timestampObj.timestamp;

    // parse JSON di ciascuna riga (ignora la prima)
    const dataLines = lines.slice(1).map(line => JSON.parse(line));

    // fetch parallelo per tutte le stazioni
    const fetches = dataLines.map(async stationData => {
      const id = stationData.N.replace(/\s+/g, "_");
      const lat = parseFloat(stationData.LAT ?? stationsLIMET[stationData.N]?.lat ?? 0);
      const lon = parseFloat(stationData.LON ?? stationsLIMET[stationData.N]?.lon ?? 0);

      const temp = stationData.T != null ? parseFloat(stationData.T) : null;
      const tempHigh = stationData.TH != null ? parseFloat(stationData.TH) : null;
      const tempLow = stationData.TL != null ? parseFloat(stationData.TL) : null;

      const hum = stationData.H != null ? parseFloat(stationData.H) : null;
      const humHigh = stationData.HH != null ? parseFloat(stationData.HH) : null;
      const humLow = stationData.HL != null ? parseFloat(stationData.HL) : null;

      const dewp = stationData.D != null ? parseFloat(stationData.D) : null;
      const wind = stationData.V != null ? parseFloat(stationData.V) : null;
      const windGust = stationData.G != null ? parseFloat(stationData.G) : null;
      const rainDaily = stationData.R != null ? parseFloat(stationData.R) : null;
      const rainRate = stationData.RR != null ? parseFloat(stationData.RR) : null;

      latestData[id] = {
        temp, tempHigh, tempLow,
        hum, humHigh, humLow,
        dewp,
        wind, windGust,
        rainDaily, rainRate,
        lat, lon,
        isInactive: temp == null && hum == null && wind == null && rainDaily == null,
        time: originalTimestamp
      };

      // salva la stazione
      stationsLimet[id] = { lat, lon };

      // crea marker se non esiste
      if (!markers[id]) createMarker(id, lat, lon);

      // aggiorna marker
      updateMarker(id);
    });

    // aspetta che tutte le stazioni siano processate
    await Promise.all(fetches);

  } catch (err) {
    console.error("Errore fetch LIMET:", err);
  }
}



async function fetch3R() {
  try {
    const url = "https://api-stazioni-meteo.vercel.app/meteo3r.json";
    const res = await fetch(url);
    const text = await res.text(); // leggere tutto come testo

    const lines = text.trim().split("\n");
    if (lines.length < 2) return;

    // prima riga: timestamp originale ISO
    const timestampObj = JSON.parse(lines[0]);
    const originalTimestamp = timestampObj.timestamp;

    // parse JSON di ciascuna riga (ignora la prima)
    const dataLines = lines.slice(1).map(line => JSON.parse(line));

    dataLines.forEach(stationData => {
      const id = stationData.N.replace(/\s+/g, "_"); // id basato sul nome
      const lat = parseFloat(stationData.LAT);
      const lon = parseFloat(stationData.LON);

      const temp = stationData.T != null ? parseFloat(stationData.T) : null;
      const tempHigh = stationData.TH != null ? parseFloat(stationData.TH) : null;
      const tempLow = stationData.TL != null ? parseFloat(stationData.TL) : null;

      const hum = stationData.H != null ? parseFloat(stationData.H) : null;
      const humHigh = stationData.HH != null ? parseFloat(stationData.HH) : null;
      const humLow = stationData.HL != null ? parseFloat(stationData.HL) : null;

      const dewp = stationData.D != null ? parseFloat(stationData.D) : null;
      const wind = stationData.V != null ? parseFloat(stationData.V) : null;
      const windGust = stationData.G != null ? parseFloat(stationData.G) : null;
      const rainDaily = stationData.R != null ? parseFloat(stationData.R) : null;
      const rainRate = stationData.RR != null ? parseFloat(stationData.RR) : null;

      latestData[id] = {
        temp, tempHigh, tempLow,
        hum, humHigh, humLow,
        dewp,
        wind, windGust,
        rainDaily, rainRate,
        lat, lon,
        isInactive: temp == null && hum == null && wind == null && rainDaily == null,
        time: originalTimestamp // <-- salvo il timestamp originale ISO
      };

      // salva la stazione
      stations3R[id] = { lat, lon };

      // crea marker se non esiste
      if (!markers[id]) createMarker(id, lat, lon);

      // aggiorna marker
      updateMarker(id);
    });

  } catch (err) {
    console.error("Errore fetch 3R:", err);
  }
}


async function fetchNetAtmo() {
  try {
    const url = "https://api-stazioni-meteo.vercel.app/netatmoLiguria.json";
    const res = await fetch(url);
    const text = await res.text(); // leggere tutto come testo

    const lines = text.trim().split("\n");
    if (lines.length < 2) return;

    // prima riga: timestamp originale ISO
    const timestampObj = JSON.parse(lines[0]);
    const originalTimestamp = timestampObj.timestamp;

    // parse JSON di ciascuna riga (ignora la prima)
    const dataLines = lines.slice(1).map(line => JSON.parse(line));

    dataLines.forEach(stationData => {
      const id = stationData.N.replace(/\s+/g, "_"); // id basato sul nome
      const lat = parseFloat(stationData.LAT);
      const lon = parseFloat(stationData.LON);

      const temp = stationData.T != null ? parseFloat(stationData.T) : null;
      const tempHigh = stationData.TH != null ? parseFloat(stationData.TH) : null;
      const tempLow = stationData.TL != null ? parseFloat(stationData.TL) : null;

      const hum = stationData.H != null ? parseFloat(stationData.H) : null;
      const humHigh = stationData.HH != null ? parseFloat(stationData.HH) : null;
      const humLow = stationData.HL != null ? parseFloat(stationData.HL) : null;

      const dewp = stationData.D != null ? parseFloat(stationData.D) : null;
      const wind = stationData.V != null ? parseFloat(stationData.V) : null;
      const windGust = stationData.G != null ? parseFloat(stationData.G) : null;
      const rainDaily = stationData.R != null ? parseFloat(stationData.R) : null;
      const rainRate = stationData.RR != null ? parseFloat(stationData.RR) : null;

      latestData[id] = {
        temp, tempHigh, tempLow,
        hum, humHigh, humLow,
        dewp,
        wind, windGust,
        rainDaily, rainRate,
        lat, lon,
        isInactive: temp == null && hum == null && wind == null && rainDaily == null,
        time: originalTimestamp // <-- salvo il timestamp originale ISO
      };

      // salva la stazione
      stationsNetAtmo[id] = { lat, lon };

      // crea marker se non esiste
      if (!markers[id]) createMarker(id, lat, lon);

      // aggiorna marker
      updateMarker(id);
    });

  } catch (err) {
    console.error("Errore fetch NetAtmo:", err);
  }
}





    // ----- Fetch dati temperatura -----
    async function fetchPws(id) {
      try {
        const urlCurrent = `https://api.weather.com/v2/pws/observations/current?apiKey=${apiKey}&stationId=${stations[id].api}&numericPrecision=decimal&format=json&units=m`;
        const resCurrent = await fetch(urlCurrent);
        const dataCurrent = await resCurrent.json();

        const temp = dataCurrent.observations[0].metric.temp;
        const dewp = dataCurrent.observations [0].metric.dewpt;
        const heat = dataCurrent.observations [0].metric.heatIndex;
        const hum = dataCurrent.observations [0].humidity;
        const rainDaily = dataCurrent.observations [0].metric.precipTotal;
        const rainRate = dataCurrent.observations [0].metric.precipRate;
        const lat = dataCurrent.observations[0].lat;
        const lon = dataCurrent.observations[0].lon;
        const wind = dataCurrent.observations[0].metric.windSpeed;
        const windGust = dataCurrent.observations[0].metric.windGust;
        const altitude = dataCurrent.observations[0].metric.elev;
        const windDir = dataCurrent.observations[0].winddir;


        const urlDaily = `https://api.weather.com/v2/pws/dailysummary/1day?apiKey=${apiKey}&stationId=${stations[id].api}&numericPrecision=decimal&format=json&units=m`;
        const resDaily = await fetch(urlDaily);
        const dataDaily = await resDaily.json();

        const summary = dataDaily.summaries && dataDaily.summaries.length > 0 ? dataDaily.summaries[0].metric : null;
        const tempHigh = summary ? summary.tempHigh : null;
        const tempLow = summary ? summary.tempLow : null;
        const dewpHigh = summary ? summary.dewptHigh : null;
        const dewpLow = summary ? summary.dewptLow : null;
        const heatHigh = summary ? summary.heatindexHigh : null;
        const heatLow = summary ? summary.heatindexLow : null;
        const humHigh = summary ? dataDaily.summaries[0].humidityHigh : null;
        const humLow = summary ? dataDaily.summaries[0].humidityLow : null;
        const windGustHigh = summary ? summary.windgustHigh : null;
        const source = "WunderGround"

        latestData[id] = { source, temp, tempHigh, tempLow, dewp, dewpHigh, dewpLow, heat, heatHigh, heatLow, hum, humHigh, humLow, rainDaily, rainRate, wind, windGust, windGustHigh, windDir, lat, lon, altitude };
        updateMarker(id);

      } catch(err) {
        console.error(`Errore fetch dati ${id}:`, err);
      }
    }
    const stationsOMIRL = {}; // qui salviamo tutte le stazioni OMIRL

    async function fetchOMIRL() {
  try {
    const url = "https://api-stazioni-meteo.vercel.app/omirl.json";
    const res = await fetch(url);
    const text = await res.text(); // leggere tutto come testo

    const lines = text.trim().split("\n");
    if (lines.length < 2) return;

    // prima riga: timestamp originale ISO
    const timestampObj = JSON.parse(lines[0]);
    const originalTimestamp = timestampObj.timestamp;

    // parse JSON di ciascuna riga (ignora la prima)
    const dataLines = lines.slice(1).map(line => JSON.parse(line));

    dataLines.forEach(stationData => {
      const id = stationData.N.replace(/\s+/g, "_"); // id basato sul nome
      const lat = parseFloat(stationData.LAT);
      const lon = parseFloat(stationData.LON);

      const temp = stationData.T != null ? parseFloat(stationData.T) : null;
      const tempHigh = stationData.TH != null ? parseFloat(stationData.TH) : null;
      const tempLow = stationData.TL != null ? parseFloat(stationData.TL) : null;

      const hum = stationData.H != null ? parseFloat(stationData.H) : null;
      const humHigh = stationData.HH != null ? parseFloat(stationData.HH) : null;
      const humLow = stationData.HL != null ? parseFloat(stationData.HL) : null;

      const dewp = stationData.D != null ? parseFloat(stationData.D) : null;
      const wind = stationData.V != null ? parseFloat(stationData.V) : null;
      const windGust = stationData.G != null ? parseFloat(stationData.G) : null;
      const rainDaily = stationData.R != null ? parseFloat(stationData.R) : null;
      const rainRate = stationData.RR != null ? parseFloat(stationData.RR) : null;

      latestData[id] = {
        temp, tempHigh, tempLow,
        hum, humHigh, humLow,
        dewp,
        wind, windGust,
        rainDaily, rainRate,
        lat, lon,
        isInactive: temp == null && hum == null && wind == null && rainDaily == null,
        time: originalTimestamp // <-- salvo il timestamp originale ISO
      };

      // salva la stazione
      stationsOMIRL[id] = { lat, lon };

      // crea marker se non esiste
      if (!markers[id]) createMarker(id, lat, lon);

      // aggiorna marker
      updateMarker(id);
    });

  } catch (err) {
    console.error("Errore fetch OMIRL:", err);
  }
}



async function fetchCML() {
  try {
    const url = "https://api-stazioni-meteo.vercel.app/cml.json";
    const res = await fetch(url);
    const text = await res.text(); // leggere tutto come testo

    const lines = text.trim().split("\n");
    if (lines.length < 2) return;

    // prima riga: timestamp originale ISO
    const timestampObj = JSON.parse(lines[0]);
    const originalTimestamp = timestampObj.timestamp;

    // parse JSON di ciascuna riga (ignora la prima)
    const dataLines = lines.slice(1).map(line => JSON.parse(line));

    dataLines.forEach(stationData => {
      const id = stationData.N.replace(/\s+/g, "_"); // id basato sul nome
      const lat = parseFloat(stationData.LAT);
      const lon = parseFloat(stationData.LON);

      const temp = stationData.T != null ? parseFloat(stationData.T) : null;
      const tempHigh = stationData.TH != null ? parseFloat(stationData.TH) : null;
      const tempLow = stationData.TL != null ? parseFloat(stationData.TL) : null;

      const hum = stationData.H != null ? parseFloat(stationData.H) : null;
      const humHigh = stationData.HH != null ? parseFloat(stationData.HH) : null;
      const humLow = stationData.HL != null ? parseFloat(stationData.HL) : null;

      const dewp = stationData.D != null ? parseFloat(stationData.D) : null;
      const wind = stationData.V != null ? parseFloat(stationData.V) : null;
      const windGust = stationData.G != null ? parseFloat(stationData.G) : null;
      const rainDaily = stationData.R != null ? parseFloat(stationData.R) : null;
      const rainRate = stationData.RR != null ? parseFloat(stationData.RR) : null;

      latestData[id] = {
        temp, tempHigh, tempLow,
        hum, humHigh, humLow,
        dewp,
        wind, windGust,
        rainDaily, rainRate,
        lat, lon,
        isInactive: temp == null && hum == null && wind == null && rainDaily == null,
        time: originalTimestamp // <-- salvo il timestamp originale ISO
      };

      // salva la stazione
      stationsCML[id] = { lat, lon };

      // crea marker se non esiste
      if (!markers[id]) createMarker(id, lat, lon);

      // aggiorna marker
      updateMarker(id);
    });

  } catch (err) {
    console.error("Errore fetch CML:", err);
  }
}
async function fetchDMA() {
  try {
    const url = "https://api-stazioni-meteo.vercel.app/datimeteoasti.json";
    const res = await fetch(url);
    const text = await res.text(); // leggere tutto come testo

    const lines = text.trim().split("\n");
    if (lines.length < 2) return;

    // prima riga: timestamp originale ISO
    const timestampObj = JSON.parse(lines[0]);
    const originalTimestamp = timestampObj.timestamp;

    // parse JSON di ciascuna riga (ignora la prima)
    const dataLines = lines.slice(1).map(line => JSON.parse(line));

    dataLines.forEach(stationData => {
      const id = stationData.N.replace(/\s+/g, "_"); // id basato sul nome
      const lat = parseFloat(stationData.LAT);
      const lon = parseFloat(stationData.LON);

      const temp = stationData.T != null ? parseFloat(stationData.T) : null;
      const tempHigh = stationData.TH != null ? parseFloat(stationData.TH) : null;
      const tempLow = stationData.TL != null ? parseFloat(stationData.TL) : null;

      const hum = stationData.H != null ? parseFloat(stationData.H) : null;
      const humHigh = stationData.HH != null ? parseFloat(stationData.HH) : null;
      const humLow = stationData.HL != null ? parseFloat(stationData.HL) : null;

      const dewp = stationData.D != null ? parseFloat(stationData.D) : null;
      const wind = stationData.V != null ? parseFloat(stationData.V) : null;
      const windGust = stationData.G != null ? parseFloat(stationData.G) : null;
      const rainDaily = stationData.R != null ? parseFloat(stationData.R) : null;
      const rainRate = stationData.RR != null ? parseFloat(stationData.RR) : null;

      latestData[id] = {
        temp, tempHigh, tempLow,
        hum, humHigh, humLow,
        dewp,
        wind, windGust,
        rainDaily, rainRate,
        lat, lon,
        isInactive: temp == null && hum == null && wind == null && rainDaily == null,
        time: originalTimestamp // <-- salvo il timestamp originale ISO
      };

      // salva la stazione
      stationsDMA[id] = { lat, lon };

      // crea marker se non esiste
      if (!markers[id]) createMarker(id, lat, lon);

      // aggiorna marker
      updateMarker(id);
    });

  } catch (err) {
    console.error("Errore fetch DMA:", err);
  }
}


const stationsTorinoMeteo = {};

async function fetchTorinoMeteo() {
  try {
    const url = "https://api-stazioni-meteo.vercel.app/torinometeo.json";
    const res = await fetch(url);
    const text = await res.text(); // leggere tutto come testo

    // dividi per linea e ignora la prima riga (timestamp)
    const lines = text.trim().split("\n").slice(1);

    // parse JSON di ciascuna riga
    const data = lines.map(line => JSON.parse(line));

    data.forEach(stationData => {
      const id = stationData.N.replace(/\s+/g, "_"); // id basato sul nome
      const lat = parseFloat(stationData.LAT);
      const lon = parseFloat(stationData.LON);

      const temp = stationData.T != null ? parseFloat(stationData.T) : null;
      const tempHigh = stationData.TH != null ? parseFloat(stationData.TH) : null;
      const tempLow = stationData.TL != null ? parseFloat(stationData.TL) : null;

      const hum = stationData.H != null ? parseFloat(stationData.H) : null;
      const humHigh = stationData.HH != null ? parseFloat(stationData.HH) : null;
      const humLow = stationData.HL != null ? parseFloat(stationData.HL) : null;

      const dewp = stationData.D != null ? parseFloat(stationData.D) : null;
      const dewpHigh = null; // non presente nei dati
      const dewpLow = null; // non presente nei dati

      const wind = stationData.V != null ? parseFloat(stationData.V) : null;
      const windGust = stationData.G != null ? parseFloat(stationData.G) : null;
      const windDir = null; // non presente nei dati
      const windDirMax = null; // non presente nei dati

      const rainDaily = stationData.R != null ? parseFloat(stationData.R) : null;
      const rainRate = stationData.RR != null ? parseFloat(stationData.RR) : null;

      latestData[id] = {
        temp, tempHigh, tempLow,
        hum, humHigh, humLow,
        dewp, dewpHigh, dewpLow,
        wind, windGust, windDir, windDirMax,
        rainDaily, rainRate,
        lat, lon,
        isInactive: temp == null && hum == null && wind == null && rainDaily == null
      };

      // salva la stazione
      stationsTorinoMeteo[id] = { lat, lon };

      // crea marker se non esiste
      if (!markers[id]) {
        createMarker(id, lat, lon);
      }

      // aggiorna marker
      updateMarker(id);
    });

  } catch (err) {
    console.error("Errore fetch TorinoMeteo:", err);
  }
}



    async function fetchStations1(id) {
  const st = stations1[id];
  if (!st) return;

  try {
    // Evita CORS e cache
    const url = "https://api.allorigins.win/get?url=" +
      encodeURIComponent(st.link) +
      "&timestamp=" + Date.now();

    const resp = await fetch(url);
    const wrapped = await resp.json();

    // Il contenuto è una stringa JSON nel campo "contents"
    const raw = JSON.parse(wrapped.contents);

    // Parse numerico sicuro (alcuni campi hanno spazi/virgole)
    const toNum = v => v == null ? null : parseFloat(String(v).replace(",", ".").trim());

    const temp      = toNum(raw.temp);
    const tempHigh  = toNum(raw.tempTH);
    const tempLow   = toNum(raw.tempTL);

    const dewp      = toNum(raw.dew);
    const dewpHigh  = toNum(raw.dewpointTH);
    const dewpLow   = toNum(raw.dewpointTL);

    const heat      = toNum(raw.heatindex);
    const heatHigh  = toNum(raw.heatindexTH);
    const heatLow   = raw.wchillTL != null ? toNum(raw.wchillTL) : null; // non esiste heatLow nel JSON

    const hum       = toNum(raw.hum);
    const humHigh   = toNum(raw.humTH);
    const humLow    = toNum(raw.humTL);

    const rainDaily = toNum(raw.rfall);
    const rainRate  = toNum(raw.rrate);

    latestData[id] = {
      temp, tempHigh, tempLow,
      dewp, dewpHigh, dewpLow,
      heat, heatHigh, heatLow,
      hum, humHigh, humLow,
      rainDaily, rainRate,
      lat: st.lat, lon: st.lon
    };

    updateMarker(id);
  } catch (err) {
    console.error(`Errore fetch stations1 ${id}:`, err);
  }
}
async function fetchStations2(id) {
  const st = stations2[id];
  if (!st) return;

  try {
    // Evita CORS e cache
    const url = "https://api.allorigins.win/get?url=" +
      encodeURIComponent(st.link) +
      "&timestamp=" + Date.now();

    const resp = await fetch(url);
    const wrapped = await resp.json();

    // Parse HTML
    const parser = new DOMParser();
    const doc = parser.parseFromString(wrapped.contents, "text/html");

    // Funzione helper per trovare valore in base all'etichetta
    function getValue(label) {
      const row = [...doc.querySelectorAll("tr")].find(tr =>
        tr.textContent.includes(label)
      );
      if (!row) return null;
      const tds = [...row.querySelectorAll("td")].map(td => td.textContent.trim());
      if (!tds[1]) return null;
      return parseFloat(tds[1].replace(",", ".").replace(/[^\d.-]/g, ""));
    }

    // Estrazione valori
    const temp      = getValue("Temperatura");
    const hum       = getValue("umidita");
    const dewp      = getValue("Punto di rugiada");
    const heat      = getValue("Indice di calore") || getValue("Temperatura percepita");
    const rainRate  = getValue("Intensita");
    const rainDaily = getValue("Pioggia");

    latestData[id] = {
      temp,
      hum,
      dewp,
      heat,
      rainRate,
      rainDaily,
      lat: st.lat,
      lon: st.lon
    };

    updateMarker(id);

  } catch (err) {
    console.error(`Errore fetch stations2 ${id}:`, err);
  }
}
async function fetchStations3(id) {
  const st = stations1[id];
  if (!st) return;

  // Crea il marker se non esiste
  if (!markers[id] && st.lat != null && st.lon != null) {
    createMarker(id, st.lat, st.lon);
  }

  try {
    const url = "https://api.allorigins.win/get?url=" +
      encodeURIComponent(st.link) +
      "&timestamp=" + Date.now();

    const resp = await fetch(url);
    const wrapped = await resp.json();

    const raw = JSON.parse(wrapped.contents);

    const toNum = v => v == null ? null : parseFloat(String(v).replace(",", ".").trim());

    const temp      = toNum(raw.temp);
    const tempHigh  = toNum(raw.temp_max);
    const tempLow   = toNum(raw.temp_min);

    const dewp      = toNum(raw.dew_point);
    const heat      = toNum(raw.heat_index);

    const hum       = toNum(raw.hum);

    const rainDaily = toNum(raw.rain);
    const rainRate  = toNum(raw.rain_rate);

    const wind      = toNum(raw.wind_avg);
    const windGust  = toNum(raw.wind_gust);
    const windGustHigh = toNum(raw.wind_gust_max);

    latestData[id] = {
      temp, tempHigh, tempLow,
      dewp, dewpHigh: null, dewpLow: null,
      heat, heatHigh: null, heatLow: null,
      hum, humHigh: null, humLow: null,
      rainDaily, rainRate,
      wind, windGust, windGustHigh,
      lat: st.lat, lon: st.lon
    };

    updateMarker(id);

  } catch (err) {
    console.error(`Errore fetch stations3 ${id}:`, err);
  }
}

async function fetchMeteoTortona(id) {
  const st = stationsMeteoTortona[id];
  try {
    const url = "https://corsproxy.io/?" + encodeURIComponent(st.link);
    const res = await fetch(url);
    const text = await res.text();

    // Temperatura
    const tempMatch = text.match(/<div class='card-header text-center font-weight-bold'>Temperatura<\/div>[\s\S]*?<h1>([\d.]+) &deg;C<\/h1>/);
    const temp = tempMatch ? parseFloat(tempMatch[1]) : null;

    const tempHighMatch = text.match(/<img src='\/immagini\/stazioni_online\/rossa.png'[\s\S]*?>Max:[\s\S]*?<div class='col-5 text-center'>([\d.]+) &deg;C<\/div>/);
    const tempHigh = tempHighMatch ? parseFloat(tempHighMatch[1]) : null;

    const tempLowMatch = text.match(/<img src='\/immagini\/stazioni_online\/blu.png'[\s\S]*?>Min:[\s\S]*?<div class='col-5 text-center'>([\d.]+) &deg;C<\/div>/);
    const tempLow = tempLowMatch ? parseFloat(tempLowMatch[1]) : null;

    // Dew point
    const dewpMatch = text.match(/<div class='card-header text-center font-weight-bold'>Dew Point<\/div>[\s\S]*?<h1>([\d.]+) &deg;C<\/h1>/);
    const dewp = dewpMatch ? parseFloat(dewpMatch[1]) : null;

    const dewpHighMatch = text.match(/<div class='col-5 text-center'>([\d.]+) &deg;C<\/div>\s*<div class='col-4 text-center'>Ore: [\d:]+<\/div>/g);
    const dewpHigh = dewpHighMatch && dewpHighMatch[0] ? parseFloat(dewpHighMatch[0].match(/([\d.]+)/)[1]) : null;
    const dewpLow = dewpHighMatch && dewpHighMatch[1] ? parseFloat(dewpHighMatch[1].match(/([\d.]+)/)[1]) : null;

    // Umidità
    const humMatch = text.match(/<div class='card-header text-center font-weight-bold'>Umidit &agrave;<\/div>[\s\S]*?<h1>([\d.]+) &#37;<\/h1>/);
    const hum = humMatch ? parseFloat(humMatch[1]) : null;

    const humMaxMatch = text.match(/<img src='\/immagini\/stazioni_online\/rossa.png'[\s\S]*?>Max:[\s\S]*?<div class='col-5 text-center'>([\d.]+) &#37;<\/div>/);
    const humHigh = humMaxMatch ? parseFloat(humMaxMatch[1]) : null;

    const humMinMatch = text.match(/<img src='\/immagini\/stazioni_online\/blu.png'[\s\S]*?>Min:[\s\S]*?<div class='col-5 text-center'>([\d.]+) &#37;<\/div>/);
    const humLow = humMinMatch ? parseFloat(humMinMatch[1]) : null;

    // Vento
    const windMatch = text.match(/<div class='card-header text-center font-weight-bold'>Vento<\/div>[\s\S]*?<h1>([\d.]+) Km\/h ([NSEW]+)<\/h1>/);
    const wind = windMatch ? parseFloat(windMatch[1]) : null;
    const windDirRaw = windMatch ? windMatch[2] : null;

    // Mappa direzione in gradi
    const dirMap = { N:0, NE:45, E:90, SE:135, S:180, SW:225, W:270, NW:315 };
    const windDir = windDirRaw && dirMap[windDirRaw.toUpperCase()] !== undefined ? dirMap[windDirRaw.toUpperCase()] : null;

    const windGustMatch = text.match(/<img src='\/immagini\/stazioni_online\/rossa.png'[\s\S]*?>Max:[\s\S]*?<div class='col-5 text-center'>([\d.]+) Km\/h<\/div>/);
    const windGustHigh = windGustMatch ? parseFloat(windGustMatch[1]) : null;

    const windGust = windGustHigh; // Se non c'è altro dato disponibile

    // Pioggia giornaliera
    const rainMatch = text.match(/<div class='card-header text-center font-weight-bold'>Precipitazioni<\/div>[\s\S]*?<h1>([\d.]+) mm<\/h1>/);
    const rainDaily = rainMatch ? parseFloat(rainMatch[1]) : null;

    latestData[id] = {
      temp,
      tempHigh,
      tempLow,
      dewp,
      dewpHigh,
      dewpLow,
      hum,
      humHigh,
      humLow,
      rainDaily,
      wind,
      windGust,
      windGustHigh,
      windDir,
      lat: st.lat,
      lon: st.lon,
      inactive: temp == null
    };

    updateMarker(id);

  } catch (err) {
    console.error(`Errore fetch stazione ${id}:`, err);
    latestData[id] = { 
      temp: null,
      tempHigh: null,
      tempLow: null,
      dewp: null,
      dewpHigh: null,
      dewpLow: null,
      hum: null,
      humHigh: null,
      humLow: null,
      rainDaily: null,
      wind: null,
      windGust: null,
      windGustHigh: null,
      windDir: null,
      lat: st.lat,
      lon: st.lon,
      inactive: true
    };
    updateMarker(id);
  }
}



async function fetchLimetBatch(batch) {
  for (let i = 0; i < batch.length; i++) {
    fetchLimet(batch[i]);  // non mettiamo await per non bloccare troppo
    await new Promise(r => setTimeout(r, 30)); // 200ms tra richieste
  }
}

// Funzione principale
function scheduleLimetFetch() {
  const ids = Object.keys(stationsLimet);
  const batchSize = 10; // numero di stazioni per batch
  let start = 0;

  function nextBatch() {
    const batch = ids.slice(start, start + batchSize);
    fetchLimetBatch(batch);

    start += batchSize;
    if (start >= ids.length) start = 0;

    setTimeout(nextBatch, 1000); // 6 secondi tra un batch e l'altro
  }

  nextBatch();
}
async function fetch3RBatch(batch) {
  for (let i = 0; i < batch.length; i++) {
    fetch3R(batch[i]);  // non mettiamo await per non bloccare troppo
    await new Promise(r => setTimeout(r, 200)); // 200ms tra richieste
  }
}

function schedule3RFetch() {
  const ids = Object.keys(stations3R);
  const batchSize = 10; // numero di stazioni per batch
  let start = 0;

  function nextBatch() {
    const batch = ids.slice(start, start + batchSize);
    fetch3RBatch(batch);

    start += batchSize;
    if (start >= ids.length) start = 0;

    setTimeout(nextBatch, 6000); // 6 secondi tra un batch e l'altro
  }

  nextBatch();
}


// ----- Inizializza Marker -----
Object.keys(stations).forEach(id => createMarker(id));
Object.keys(stationsTorinoMeteo).forEach(id => createMarker(id));
Object.keys(stationsCML).forEach(id => createMarker(id));
Object.keys(stationsOMIRL).forEach(id => createMarker(id));
Object.keys(stations3R).forEach(id => createMarker(id));
Object.keys(stationsNetAtmo).forEach(id => createMarker(id));
Object.keys(stationsMeteoTortona).forEach(id => createMarker(id));
Object.keys(stationsDMA).forEach(id => createMarker(id));
Object.keys(stations1).forEach(id => createMarker(id));
Object.keys(stations2).forEach(id => createMarker(id));
Object.keys(stations3).forEach(id => createMarker(id));
Object.keys(stationsLimet).forEach(id => createMarker(id));
Object.keys(stationsBest).forEach(id => createMarker(id));

Object.keys(stations).forEach(id => fetchPws(id));
fetchCML(); // fetch unico per tutte le stazioni CML
fetchOMIRL();
fetchLimet();
fetch3R();
fetchNetAtmo();
fetchTorinoMeteo();
fetchDMA();
Object.keys(stationsMeteoTortona).forEach(id => fetchMeteoTortona(id));
Object.keys(stations1).forEach(id => fetchStations1(id));
Object.keys(stations2).forEach(id => fetchStations2(id));
Object.keys(stations3).forEach(id => fetchStations3(id));
Object.keys(stationsBest).forEach(id => fetchPws(id));


    // Aggiornamento ogni 10 secondi
setInterval(() => { Object.keys(stations).forEach(id => fetchPws(id)); }, 60000);
setInterval(() => { fetchCML(); }, 30000);
setInterval(() => { fetchOMIRL(); }, 30000);
setInterval(() => { fetchTorinoMeteo(); }, 60000);
setInterval(() => { fetchNetAtmo(); }, 60000);
setInterval(() => { fetch3R(); }, 150000);
setInterval(() => { fetchLimet(); }, 30000);
setInterval(() => { fetchDMA(); }, 150000);
setInterval(() => { Object.keys(stationsMeteoTortona).forEach(id => fetchMeteoTortona(id)); }, 30000);
setInterval(() => { Object.keys(stations1).forEach(id => fetchStations1(id)); }, 15000);
setInterval(() => { Object.keys(stations2).forEach(id => fetchStations2(id)); }, 135000);
setInterval(() => { Object.keys(stations2).forEach(id => fetchStations3(id)); }, 15000);
setInterval(() => {Object.keys(stationsBest).forEach(id => fetchPws(id));}, 5000);

    // Cambia tipo di temperatura
    document.getElementById("tempSelect").addEventListener("change", () => {
  Object.keys(stations).forEach(id => updateMarker(id));
  Object.keys(stationsTorinoMeteo).forEach(id => updateMarker(id));
  Object.keys(stationsNetAtmo).forEach(id => updateMarker(id));
  Object.keys(stationsCML).forEach(id => updateMarker(id));
  Object.keys(stationsOMIRL).forEach(id => updateMarker(id));
  Object.keys(stations3R).forEach(id => updateMarker(id));
  Object.keys(stationsMeteoTortona).forEach(id => updateMarker(id));
  Object.keys(stationsDMA).forEach(id => updateMarker(id));
  Object.keys(stationsLimet).forEach(id => updateMarker(id));
  Object.keys(stations1).forEach(id => updateMarker(id));
  Object.keys(stations2).forEach(id => updateMarker(id));
  Object.keys(stations3).forEach(id => updateMarker(id));
  Object.keys(stationsBest).forEach(id => updateMarker(id));
    });
    // Dopo createMarker / updateMarker di tutte le stazioni
filterMarkersBySource();

  </script>
</body>
</html>