<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Gauges</title>

<!-- SteelSeries (HanSolo) + Tween per animazioni -->
<script src="https://cdn.jsdelivr.net/gh/HanSolo/SteelSeries-Canvas/tween-min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/HanSolo/SteelSeries-Canvas/steelseries.js"></script>

<style>
  body { margin:0; font-family:Arial,sans-serif; background:#fff; color:#0b1020 }
  header { padding:16px 20px; display:flex; align-items:baseline; gap:12px }
  header h1 { margin:0; font-size:20px; font-weight:700 }
  header .sub { color:#4b4b3c; font-size:13px }
  #updated { color:#4b4b3c; font-size:12px; margin-left:auto }
  .grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); gap:18px; padding:18px; max-width:1200px; margin:0 auto }
  .card { background:#eee7d3; border-radius:18px; padding:14px; box-shadow:0 6px 24px rgba(0,0,0,.15) }
  .card h3 { margin:0 0 8px; font-size:14px; font-weight:600; color:#0b1020 }
  .row { display:flex; gap:14px; align-items:center; justify-content:space-between }
  .meta { font-size:12px; color:#4b4b3c }
  .meta b { color:#0b1020; font-weight:700 }
  canvas { display:block; margin:0 auto }
  footer { text-align:center; color:#6b7280; font-size:12px; padding:12px 0 28px }
</style>
</head>
<body>
<header>
  <h1 id="stationTitle">Stazione Meteo: —</h1>
  <span class="sub">Dati in tempo reale (unità metriche)</span>
  <span id="updated">Aggiornamento…</span>
</header>

<div class="grid">
  <div class="card"><h3>Temperatura (°C)</h3><canvas id="g_temp" width="260" height="260"></canvas>
    <div class="row"><div class="meta">Dew point: <b id="dewpt">—</b> °C</div><div class="meta">Percepita: <b id="feels">—</b> °C</div></div></div>
  <div class="card"><h3>Dew Point (°C)</h3><canvas id="g_dew" width="260" height="260"></canvas></div>
  <div class="card"><h3>Umidità (%)</h3><canvas id="g_rh" width="260" height="260"></canvas>
    <div class="row"><div class="meta">UR: <b id="rh_txt">—</b> %</div><div class="meta">UV: <b id="uv">—</b></div></div></div>
  <div class="card"><h3>Pressione (hPa)</h3><canvas id="g_press" width="260" height="260"></canvas>
    <div class="row"><div class="meta">Trend: <b id="ptrend">—</b></div><div class="meta">QNH: <b id="p_txt">—</b> hPa</div></div></div>
  <div class="card"><h3>Vento (km/h)</h3><canvas id="g_wind" width="260" height="260"></canvas>
    <div class="row"><div class="meta">Dir: <b id="wdir">—</b>°</div><div class="meta">Raffica: <b id="gust">—</b> km/h</div></div></div>
  <div class="card"><h3>Pioggia totale (mm)</h3><canvas id="g_rain" width="260" height="260"></canvas>
    <div class="row"><div class="meta">Giorno: <b id="rtotal">—</b> mm</div></div></div>
  <div class="card"><h3>Rain Rate (mm/h)</h3><canvas id="g_rainrate" width="260" height="260"></canvas></div>
<div id="gaugeTooltip" style="position:absolute; pointer-events:none; background:rgba(0,0,0,0.8); color:#fff; padding:4px 8px; border-radius:4px; font-size:12px; display:none;"></div>

</div>

<footer>Gauges: SteelSeries-Canvas · Dati da Weather.com / OMIRL / LIMET</footer>

<script>
const urlParams = new URLSearchParams(window.location.search);
const stationId = urlParams.get("station") || "ICREMO15";
const stationName = urlParams.get("name") || stationId;
const source = urlParams.get("source") || "wunderground";

document.title = `WeatherCloud — Stazione ${stationName}`;
document.getElementById("stationTitle").textContent = `Stazione Meteo: ${stationName}`;

const REFRESH_MS = 5000;
const $ = id => document.getElementById(id);
const setText = (id,v) => { if($(id)) $(id).textContent=v; };
function fmt1(n){ return (n===null||n===undefined||isNaN(n)) ? "—" : Number(n).toFixed(1); }
const stations3R = {};
const stationsMeteoTortona =  {
  Tortona: {
    link: "https://meteotortona.it/link/dettaglio_stazioni.php?stazione=tortona",
    lat: 44.897,            // latitudine
    lon: 8.863              // longitudine
  }, 
  Casale: {
    link: "https://meteotortona.it/link/dettaglio_stazioni.php?stazione=casale",
    lat: 45.137,            // latitudine
    lon: 8.449              // longitudine
  },
  Pozzolo: {
    link: "https://meteotortona.it/link/dettaglio_stazioni.php?stazione=pozzolo",
    lat: 44.791,            // latitudine
    lon: 8.784              // longitudine
  },
  CasaCabano: {
    link: "https://meteotortona.it/link/dettaglio_stazioni.php?stazione=casacabano",
    lat: 44.840,            // latitudine
    lon: 9.250              // longitudine
  },
  AlberaLigure: {
    link: "https://meteotortona.it/link/dettaglio_stazioni.php?stazione=albera",
    lat: 44.7,            // latitudine
    lon: 9.065              // longitudine
  },
  Daglio: {
    link: "https://meteotortona.it/link/dettaglio_stazioni.php?stazione=daglio",
    lat: 44.645,            // latitudine
    lon: 9.149              // longitudine
  },
  Cosola: {
    link: "https://meteotortona.it/link/dettaglio_stazioni.php?stazione=cosola",
    lat: 44.669,            // latitudine
    lon: 9.178              // longitudine
  },
}
const stationsCML = {
  andalo: { lat: null, lon: null },
  aprica:   { lat: null, lon: null },
  ardenno:  { lat: 46.169, lon: 9.652 },
  bormio:   { lat: 46.468, lon: 10.368 },
  bormio_cimino: { lat: 46.433, lon: 10.405 },
  caiolo: { lat: 46.151, lon: 9.816 },
  campotartano: { lat: 46.132, lon: 9.665 },
  castione_andevenno: { lat: 46.171, lon: 9.802 },
  castionetto: { lat: 46.175, lon: 10.005 },
  cepina: { lat: 46.426, lon: 10.356 },
  forcola: { lat: 46.157, lon: 9.662 },
  fraciscio: { lat: 46.403, lon: 9.365 },
  chiavenna: { lat: 46.319, lon: 9.399 },
  civo: { lat: 46.153, lon: 9.559 },
  lanzada: { lat: 46.268, lon: 9.872 },
  livigno_carosello: { lat: 46.515, lon: 10.087 },
  livigno_forcola: { lat: 46.442, lon: 10.057 },
  madesimo: { lat: 46.436, lon: 9.359 },
  montagna_valtellina: { lat: 46.176, lon: 9.904 },
  novate_m: { lat: 46.219, lon: 9.449 },
  oga: { lat: 46.462, lon: 10.346 },
  pescegallo: { lat: 46.038, lon: 9.572 },
  geisterspitze: { lat: 46.496, lon: 10.477 },
  rasura: { lat: 46.100, lon: 9.553 },
  sm_valmasino: { lat: 46.215, lon: 9.638 },
  santacaterina: { lat: 46.411, lon: 10.495 },
  somaggia:  { lat: 46.252, lon: 9.420 },
  sondalo: { lat: 46.330, lon: 10.326 },
  sondrio: { lat: 46.167, lon: 9.869 },
  talamona: { lat: 46.137, lon: 9.610 },
  tirano: { lat: 46.211, lon: 10.168 },
  tirano_centralina: { lat: 46.221, lon: 10.184 },
  tovo_sagata: { lat: 46.247, lon: 10.245 },
  trivigno: { lat: 46.189, lon: 10.199 },
  presure: { lat: 46.404, lon: 10.345 },
  villatirano: { lat: 46.204, lon: 10.134 },
  besnate: { lat: 45.698, lon: 8.767 },
  buguggiate: { lat: 45.779, lon: 8.811 },
  busto_arsizio: { lat: 45.613, lon: 8.852 },
  biandronno: { lat: 45.818, lon: 8.710 },
  brebbia: { lat: 45.827, lon: 8.648 },
  cantello: { lat: 45.821, lon: 8.896 },
  castronno: { lat: 45.745, lon: 8.815 },
  gemonio: { lat: 45.877, lon: 8.675 },
  portoceresio: { lat: 45.902, lon: 8.901 },
  rasa_varese: { lat: 45.866, lon: 8.805 },
  carnago: { lat: 45.721, lon: 8.835 },
  vizzola: { lat: 45.628, lon: 8.689 },
  cerro: { lat: 45.870, lon: 8.698 },
  cimbro: { lat: 45.735, lon: 8.719 },
  crosio: { lat: 45.762, lon: 8.766 },
  cugliate: { lat: 45.943, lon: 8.820 },
  crenna: { lat: 45.649, lon: 8.794 },
  indunno: { lat: 45.844, lon: 8.836 },
  jerago: { lat: 45.705, lon: 8.792 },
  luvinate: { lat: 45.837, lon: 8.769 },
  maccagno: { lat: 46.041, lon: 8.736 },
  nizzolina: { lat: 45.625, lon: 8.915 },
  ssalvatore: { lat: 45.787, lon: 8.900 },
  sangiano: { lat: 45.872, lon: 8.631 },
  samarate: { lat: 45.628, lon: 8.784 },
  tradate: { lat: 45.709, lon: 8.908 },
  tronzano: { lat: 46.091, lon: 8.736 },
  uboldo: { lat: 45.613, lon: 9.001 },
  va_ospedale: { lat: 45.808, lon: 8.840 },
  vedano_olona: { lat: 45.776, lon: 8.889 },
  venegono_pcastello: { lat: 45.749, lon: 8.907 },
  albavilla: { lat: null, lon: null },
albese: { lat: null, lon: null },
albiolo: { lat: null, lon: null },
alzate: { lat: null, lon: null },
anzano_dp: { lat: null, lon: null },
arosio: { lat: null, lon: null },
bellagio_cernobbio: { lat: null, lon: null },
figliaro: { lat: null, lon: null },
bregnano: { lat: null, lon: null },
brunate: { lat: null, lon: null },
bulgarograsso: { lat: null, lon: null },
cadorago: { lat: null, lon: null },
cantu_amata: { lat: null, lon: null },
cantu_porta: { lat: null, lon: null },
cantu_pianella: { lat: null, lon: null },
torno: { lat: null, lon: null },
careggiola: { lat: null, lon: null },
carimate: { lat: null, lon: null },
carimate_vedroni: { lat: null, lon: null },
casasco_intelvi: { lat: null, lon: null },
caslino: { lat: null, lon: null },
casnate: { lat: null, lon: null },
co_sagnino: { lat: null, lon: null },
co_trecallo: { lat: null, lon: null },
cucciago: { lat: null, lon: null },
fino_mornasco: { lat: null, lon: null },
geralario: { lat: null, lon: null },
gravedona: { lat: null, lon: null },
guanzate: { lat: null, lon: null },
loveno: { lat: null, lon: null },
mariano: { lat: null, lon: null },
merone: { lat: null, lon: null },
monguzzo: { lat: null, lon: null },
montorfano: { lat: null, lon: null },
piandispagna: { lat: null, lon: null },
porlezza: { lat: null, lon: null },
cernobbio_rovenna: { lat: null, lon: null },
cirimido: { lat: null, lon: null },
sormano: { lat: null, lon: null },
co_depuratore: { lat: null, lon: null },
co_aeroclub: { lat: null, lon: null },
co_breccia: { lat: null, lon: null },
co_camerlata: { lat: null, lon: null },
co_olimpino: { lat: null, lon: null },
dongo: { lat: null, lon: null },
erbacentro: { lat: null, lon: null },
inverigo: { lat: null, lon: null },
lenno: { lat: null, lon: null },
lomazzo_nord: { lat: null, lon: null },
moltrasio_lago: { lat: null, lon: null },
mozzate: { lat: null, lon: null },
olgiate: { lat: null, lon: null },
ossuccio: { lat: null, lon: null },
valmorea: { lat: null, lon: null },
venianoparco: { lat: null, lon: null },
minoprio: { lat: null, lon: null },
verzago: { lat: null, lon: null },
villaguardia: { lat: null, lon: null },
abbadia: { lat: null, lon: null },
alpe_giumello: { lat: null, lon: null },
barzago: { lat: null, lon: null },
barzio: { lat: null, lon: null },
bonzeno: { lat: null, lon: null },
bevera: { lat: null, lon: null },
cernusco: { lat: null, lon: null },
monticello_cn: { lat: null, lon: null },
erve: { lat: null, lon: null },
galbiate: { lat: null, lon: null },
lecco_germanedo: { lat: null, lon: null },
lecco_sgiovanni: { lat: null, lon: null },
bellano_lezzeno: { lat: null, lon: null },
maggio_casere: { lat: null, lon: null },
cornizzolo: { lat: null, lon: null },
dervio: { lat: null, lon: null },
garlate: { lat: null, lon: null },
lecco: { lat: null, lon: null },
maggio: { lat: null, lon: null },
mandello: { lat: null, lon: null },
oggiono: { lat: null, lon: null },
olginate: { lat: null, lon: null },
olivetolario: { lat: null, lon: null },
osnago: { lat: null, lon: null },
perego: { lat: null, lon: null },
perledo_cantone: { lat: null, lon: null },
pianiresinelli: { lat: null, lon: null },
orscellera: { lat: null, lon: null },
premana: { lat: null, lon: null },
rovagnate: { lat: null, lon: null },
santamariasancina: { lat: null, lon: null },
taceno: { lat: null, lon: null },
valmadrera: { lat: null, lon: null },
noceno: { lat: null, lon: null },
vestreno: { lat: null, lon: null },
alme: { lat: null, lon: null },
alzano: { lat: null, lon: null },
ambivere: { lat: null, lon: null },
berbenno: { lat: null, lon: null },
branzi: { lat: null, lon: null },
brignano: { lat: null, lon: null },
caprino: { lat: null, lon: null },
colere_paese: { lat: null, lon: null },
comun_nuovo: { lat: null, lon: null },
costa_serina: { lat: null, lon: null },
costavolpino: { lat: null, lon: null },
dalmine: { lat: null, lon: null },
filago: { lat: null, lon: null },
fiobbio: { lat: null, lon: null },
fontanella: { lat: null, lon: null },
fonteno: { lat: null, lon: null },
geromina: { lat: null, lon: null },
gorno: { lat: null, lon: null },
leffe: { lat: null, lon: null },
rifugiocampel: { lat: null, lon: null },
mapello_stadio: { lat: null, lon: null },
cornagera: { lat: null, lon: null },
montemisma: { lat: null, lon: null },
monte_suchello: { lat: null, lon: null },
mozzanica: { lat: null, lon: null },
olmo: { lat: null, lon: null },
paladina: { lat: null, lon: null },
palazzago: { lat: null, lon: null },
burligo: { lat: null, lon: null },
peghera: { lat: null, lon: null },
peia: { lat: null, lon: null },
pontesp: { lat: null, lon: null },
pontesp_3b: { lat: null, lon: null },
pontida: { lat: null, lon: null },
presezzo: { lat: null, lon: null },
piandeltermen: { lat: null, lon: null },
arera: { lat: null, lon: null },
rif_passosanmarco: { lat: null, lon: null },
roncola: { lat: null, lon: null },
rota_imagna: { lat: null, lon: null },
rifugio_parafulmine: { lat: null, lon: null },
rota_boscospesso: { lat: null, lon: null },
strozza: { lat: null, lon: null },
valcanale: { lat: null, lon: null },
zorzino: { lat: null, lon: null },
schilpario: { lat: null, lon: null },
poscante: { lat: null, lon: null },
capovalle: { lat: null, lon: null },
cenatesopra: { lat: null, lon: null },
cene: { lat: null, lon: null },
mapello: { lat: null, lon: null },
mozzo: { lat: null, lon: null },
pascoletto: { lat: null, lon: null },
sarnico: { lat: null, lon: null },
selvino: { lat: null, lon: null },
serina: { lat: null, lon: null },
rifugiovodala: { lat: null, lon: null },
stezzano: { lat: null, lon: null },
trevigliosud: { lat: null, lon: null },
valbondione: { lat: null, lon: null },
rifugiocuro: { lat: null, lon: null },
valcava: { lat: null, lon: null },
villadogna: { lat: null, lon: null },
villadiserio: { lat: null, lon: null },
zambla: { lat: null, lon: null },
artogne: { lat: null, lon: null },
bagnolomella: { lat: null, lon: null },
bagolino: { lat: null, lon: null },
bedizzole: { lat: null, lon: null },
borno: { lat: null, lon: null },
bresciachiesanuova: { lat: null, lon: null },
capovalle_valsabbia: { lat: null, lon: null },
castelmella: { lat: null, lon: null },
castrezzato: { lat: null, lon: null },
cedegolo: { lat: null, lon: null },
centenaro: { lat: null, lon: null },
clusane_iseo: { lat: null, lon: null },
cizzago: { lat: null, lon: null },
cazzago: { lat: null, lon: null },
desenzano: { lat: null, lon: null },
esine: { lat: null, lon: null },
barbariga: { lat: null, lon: null },
bione: { lat: null, lon: null },
brandico: { lat: null, lon: null },
bresciacastello: { lat: null, lon: null },
bresciafornaci: { lat: null, lon: null },
mompiano: { lat: null, lon: null },
gavardo: { lat: null, lon: null },
isorella: { lat: null, lon: null },
limone_garda: { lat: null, lon: null },
cimarest: { lat: null, lon: null },
cortefranca: { lat: null, lon: null },
magasa_denai: { lat: null, lon: null },
nave: { lat: null, lon: null },
ome: { lat: null, lon: null },
cavallino_fobbia: { lat: null, lon: null },
piamborno: { lat: null, lon: null },
lumezzane: { lat: null, lon: null },
noffo: { lat: null, lon: null },
plan_montecampione: { lat: null, lon: null },
pontedilegno: { lat: null, lon: null },
prevalle: { lat: null, lon: null },
edolo: { lat: null, lon: null },
gussago: { lat: null, lon: null },
leno: { lat: null, lon: null },
mazzano: { lat: null, lon: null },
montestino: { lat: null, lon: null },
montecampione: { lat: null, lon: null },
paderno_fc: { lat: null, lon: null },
palazzolo: { lat: null, lon: null },
sale_marasino: { lat: null, lon: null },
sangervasio: { lat: null, lon: null },
pozzolengo: { lat: null, lon: null },
provaglio: { lat: null, lon: null },
provezze: { lat: null, lon: null },
roncadelle: { lat: null, lon: null },
sabbio: { lat: null, lon: null },
saviore: { lat: null, lon: null },
sellero: { lat: null, lon: null },
toscolano: { lat: null, lon: null },
tremosine: { lat: null, lon: null },
valliot: { lat: null, lon: null },
vestone: { lat: null, lon: null },
villapedergnano: { lat: null, lon: null },
villanuova_test: { lat: null, lon: null },
villanuova: { lat: null, lon: null },
ala: { lat: null, lon: null },
riva: { lat: null, lon: null },
saone: { lat: null, lon: null },
tonale: { lat: null, lon: null },
dossobuono: { lat: null, lon: null },
peschiera: { lat: null, lon: null },
brugherio: { lat: null, lon: null },
busnago: { lat: null, lon: null },
ceriano_laghetto: { lat: null, lon: null },
cesano_maderno: { lat: null, lon: null },
lesmo: { lat: null, lon: null },
monza: { lat: null, lon: null },
monza_triante: { lat: null, lon: null },
novamilanese: { lat: null, lon: null },
seregno: { lat: null, lon: null },
villasanta: { lat: null, lon: null },
borgo_ticino: { lat: null, lon: null },
borgomanero: { lat: null, lon: null },
briona: { lat: null, lon: null },
invorio: { lat: null, lon: null },
meina: { lat: null, lon: null },
novara: { lat: null, lon: null },
soriso: { lat: null, lon: null },
abbiategrasso: { lat: null, lon: null },
albairate: { lat: null, lon: null },
bollate: { lat: null, lon: null },
buccinasco_robbiolo: { lat: null, lon: null },
buccinasco_4m: { lat: null, lon: null },
buccinasco_rb: { lat: null, lon: null },
caleppio: { lat: null, lon: null },
canegrate: { lat: null, lon: null },
casarile: { lat: null, lon: null },
cassano_adda: { lat: null, lon: null },
castano: { lat: null, lon: null },
cesate: { lat: null, lon: null },
cinisello_bm: { lat: null, lon: null },
cisliano: { lat: null, lon: null },
corbetta: { lat: null, lon: null },
corsico: { lat: null, lon: null },
legnano_pc: { lat: null, lon: null },
legnano_a8: { lat: null, lon: null },
mi_quartoggiaro: { lat: null, lon: null },
mi_selvanesco: { lat: null, lon: null },
mediglia: { lat: null, lon: null },
locate_triulzi: { lat: null, lon: null },
magenta: { lat: null, lon: null },
melegnano: { lat: null, lon: null },
mi_boscoincitta: { lat: null, lon: null },
mi_cadorna: { lat: null, lon: null },
gaggiano: { lat: null, lon: null },
inveruno: { lat: null, lon: null },
legnano: { lat: null, lon: null },
malvaglio: { lat: null, lon: null },
marcallo: { lat: null, lon: null },
mi_lambrate: { lat: null, lon: null },
mi_parconord: { lat: null, lon: null },
mi_genova: { lat: null, lon: null },
mi_sanleonardo: { lat: null, lon: null },
mi_arbe: { lat: null, lon: null },
mi_sansiro: { lat: null, lon: null },
nerviano: { lat: null, lon: null },
nosate: { lat: null, lon: null },
ossona: { lat: null, lon: null },
pieve_emanuele: { lat: null, lon: null },
rescaldina: { lat: null, lon: null },
rho: { lat: null, lon: null },
robecco: { lat: null, lon: null },
rovagnasco: { lat: null, lon: null },
roveda: { lat: null, lon: null },
sedriano: { lat: null, lon: null },
segrate_space: { lat: null, lon: null },
settimo_mil: { lat: null, lon: null },
trezzanorosa: { lat: null, lon: null },
vignate: { lat: null, lon: null },
vimodrone: { lat: null, lon: null },
zibidosangiacomo: { lat: null, lon: null },
cadilana: { lat: null, lon: null },
casalpusterlengo: { lat: null, lon: null },
codogno: { lat: null, lon: null },
codogno_itas: { lat: null, lon: null },
lodi: { lat: null, lon: null },
maleo: { lat: null, lon: null },
massalengo: { lat: null, lon: null },
sanangelo_lodigiano: { lat: null, lon: null },
cast_fogliani: { lat: null, lon: null },
castelsangiovanni: { lat: null, lon: null },
caorso: { lat: null, lon: null },
gossolengo: { lat: null, lon: null },
pianello_valtidone: { lat: null, lon: null },
bobbio: { lat: null, lon: null },
vigolzone: { lat: null, lon: null },
zerba: { lat: null, lon: null },
capergnanica: { lat: null, lon: null },
casalmaggiore: { lat: null, lon: null },
casalmorano: { lat: null, lon: null },
castelleone: { lat: null, lon: null },
credera: { lat: null, lon: null },
crema: { lat: null, lon: null },
cremona: { lat: null, lon: null },
cremosano: { lat: null, lon: null },
isola_pescaroli: { lat: null, lon: null },
offanengo: { lat: null, lon: null },
olmeneta: { lat: null, lon: null },
ossolaro: { lat: null, lon: null },
pignano: { lat: null, lon: null },
passarera: { lat: null, lon: null },
piadena: { lat: null, lon: null },
sg_incroce: { lat: null, lon: null },
solarolo: { lat: null, lon: null },
soncino: { lat: null, lon: null },
soresina: { lat: null, lon: null },
trescore_cremasco: { lat: null, lon: null },
trigolo: { lat: null, lon: null },
asola: { lat: null, lon: null },
canicossa: { lat: null, lon: null },
castelgoffredo: { lat: null, lon: null },
cesole: { lat: null, lon: null },
cividale_mantovano: { lat: null, lon: null },
gazoldo_ippoliti: { lat: null, lon: null },
mantova: { lat: null, lon: null },
pomponesco: { lat: null, lon: null },
guidizzolo: { lat: null, lon: null },
curtatone: { lat: null, lon: null },
sangiorgiomn: { lat: null, lon: null },
goito: { lat: null, lon: null },
monzambano: { lat: null, lon: null },
piubega: { lat: null, lon: null },
poggiorusco: { lat: null, lon: null },
porto_mn: { lat: null, lon: null },
rivalta: { lat: null, lon: null },
sanbenedettopo: { lat: null, lon: null },
sermide: { lat: null, lon: null },
suzzara: { lat: null, lon: null },
villapoma: { lat: null, lon: null },
broni: { lat: null, lon: null },
broni_golgi: { lat: null, lon: null },
gambirana: { lat: null, lon: null },
carbonara_ticino: { lat: null, lon: null },
cassolnovo: { lat: null, lon: null },
dorno: { lat: null, lon: null },
filighera: { lat: null, lon: null },
mede_vvf: { lat: null, lon: null },
mezzanino: { lat: null, lon: null },
pv_sangiovannino: { lat: null, lon: null },
piandelpoggio: { lat: null, lon: null },
pietragavina: { lat: null, lon: null },
retorbido: { lat: null, lon: null },
fortunago: { lat: null, lon: null },
gualdrasco: { lat: null, lon: null },
canneto: { lat: null, lon: null },
casorateprimo: { lat: null, lon: null },
branduzzo: { lat: null, lon: null },
cavamanara: { lat: null, lon: null },
mortara_vvf: { lat: null, lon: null },
zerbolo: { lat: null, lon: null },
corteolona: { lat: null, lon: null },
brallo: { lat: null, lon: null },
magherno: { lat: null, lon: null },
penice: { lat: null, lon: null },
ottobiano: { lat: null, lon: null },
pv_pelizza: { lat: null, lon: null },
redavalle: { lat: null, lon: null },
robbio: { lat: null, lon: null },
sm_versa: { lat: null, lon: null },
scaldasole: { lat: null, lon: null },
spessa: { lat: null, lon: null },
stefanago: { lat: null, lon: null },
stradella: { lat: null, lon: null },
tromello: { lat: null, lon: null },
vallelomellina: { lat: null, lon: null },
varzi: { lat: null, lon: null },
vidigulfo: { lat: null, lon: null },
vigevano: { lat: null, lon: null },
voghera: { lat: null, lon: null },
zinasco: { lat: null, lon: null },
acqui_terme: { lat: null, lon: null },
alessandria: { lat: null, lon: null },
castelnuovo_s: { lat: null, lon: null },
isolasantonio: { lat: null, lon: null },
pontecurone: { lat: null, lon: null },
valenza: { lat: null, lon: null },
crodo: { lat: null, lon: null },
domodossola: { lat: null, lon: null },
varzo: { lat: null, lon: null },
asigliano: { lat: null, lon: null },
};
const stationsLimet = {
  Molassana: {
    link: "molassana-alta", // parte variabile della URL
    link2: "terzereti",
    lat: 44.461,            // latitudine
    lon: 8.987              // longitudine
  },
  Fabbriche: {
    link: "fabbriche-brusinetti", // parte variabile della URL
    link2: "meteo-fabbriche-brusinetti",
    lat: 44.446,            // latitudine
    lon: 8.714              // longitudine
  },
  Pietralavezzara: {
    link: "pietralavezzara", // parte variabile della URL
    link2: "meteo-pietralavezzara",
    lat: 44.536,            // latitudine
    lon: 8.883              // longitudine
  },
  SantOlcese: {
    link: "solcese", // parte variabile della URL
    link2: "meteo-solcese",
    lat: 44.483,            // latitudine
    lon: 8.966             // longitudine
  },
  Foce: {
    link: "ldoria", // parte variabile della URL
    link2: "meteo-ldoria",
    lat: 44.401,            // latitudine
    lon: 8.942            // longitudine
  },
  Pontori: {
    link: "pontori", // parte variabile della URL
    link2: "meteo-pontori",
    lat: 44.367,            // latitudine
    lon: 9.435        // longitudine
  },
  Arenzano: {
    link: "arenzano-porto", // parte variabile della URL
    link2: "terzereti",
    lat: 44.400,            // latitudine
    lon: 8.687            // longitudine
  },
  WTC: {
    link: "wtc", // parte variabile della URL
    link2: "meteo-wtc",
    lat: 44.408,            // latitudine
    lon: 8.901              // longitudine
  },
  Sampierdarena: {
    link: "sampierdarena", // parte variabile della URL
    link2: "meteo-sampierdarena",
    lat: 44.416,            // latitudine
    lon: 8.886              // longitudine
  },
  Parazzuolo: {
    link: "parazzuolo", // parte variabile della URL
    link2: "meteo-parazzuolo",
    lat: 44.478,            // latitudine
    lon: 9.325             // longitudine
    
  },
  Montoggio: {
    link: "montoggio", // parte variabile della URL
    link2: "meteo-montoggio",
    lat: 44.517,            // latitudine
    lon: 9.050             // longitudine
    
  },
  SanRocco: {
    link: "sanrocco", // parte variabile della URL
    link2: "meteo-sanrocco",
    lat: 44.334,            // latitudine
    lon: 9.161             // longitudine
    
  },
  SantAlberto: {
    link: "salberto", // parte variabile della URL
    link2: "meteo-salberto",
    lat: 44.444,            // latitudine
    lon: 9.103             // longitudine
    
  },
  LagoLame: {
    link: "lame", // parte variabile della URL
    link2: "meteo-lame",
    lat: 44.503,            // latitudine
    lon: 9.408             // longitudine
    
  },
  Rezzoaglio: {
    link: "rezzoaglio", // parte variabile della URL
    link2: "meteo-rezzoaglio",
    lat: 44.525,            // latitudine
    lon: 9.385             // longitudine
    
  },
  RezzoaglioCerisola: {
    link: "rezzoaglio-cerisola", // parte variabile della URL
    link2: "meteo-rezzoaglio-cerisola",
    lat: 44.515,            // latitudine
    lon: 9.408             // longitudine
    
  },
  PuntaChiappa: {
    link: "batterie-pchiappa", // parte variabile della URL
    link2: "meteo-batterie-pchiappa",
    lat: 44.322,            // latitudine
    lon: 9.152             // longitudine
    
  },
  Ventarola: {
    link: "ventarola", // parte variabile della URL
    link2: "meteo-ventarola",
    lat: 44.555,            // latitudine
    lon: 9.305             // longitudine
    
  },
  ICBorzoli: {
    link: "borzoli", // parte variabile della URL
    link2: "meteo-borzoli",
    lat: 44.429,            // latitudine
    lon: 8.856             // longitudine
    
  },
  SantEusebio: {
    link: "eusebio", // parte variabile della URL
    link2: "meteo-eusebio",
    lat: 44.442,            // latitudine
    lon: 8.991             // longitudine
    
  },
  Fregarie: {
    link: "fregarie-scolombano", // parte variabile della URL
    link2: "meteo-fregarie-scolombano",
    lat: 44.380,            // latitudine
    lon: 9.305             // longitudine
    
  },
  Zoagli: {
    link: "zoagli-oliveto", // parte variabile della URL
    link2: "meteo-zoagli-oliveto",
    lat: 44.344,            // latitudine
    lon: 9.275             // longitudine
    
  },
  Moconesi: {
    link: "moconesi", // parte variabile della URL
    link2: "meteo-moconesi",
    lat: 44.424,            // latitudine
    lon: 9.190             // longitudine
    
  },
  SantaMaria: {
    link: "smaria", // parte variabile della URL
    link2: "meteo-smaria",
    lat: 44.358,            // latitudine
    lon: 9.186             // longitudine
    
  },
  Murlo: {
    link: "murlo", // parte variabile della URL
    link2: "meteo-murlo",
    lat: 44.055,            // latitudine
    lon: 9.956             // longitudine
    
  },
  Urbe: {
    link: "terzereti", // parte variabile della URL
    link2: "meteo-urbe-monta",
    lat: 44.489,            // latitudine
    lon: 8.581             // longitudine
    
  },
  UrbeSanPietro: {
    link: "urbe", // parte variabile della URL
    link2: "meteo-urbe",
    lat: 44.486,            // latitudine
    lon: 8.587             // longitudine
    
  },
  Tiglieto: {
    link: "tiglieto", // parte variabile della URL
    link2: "meteo-tiglieto",
    lat: 44.529,            // latitudine
    lon: 8.626             // longitudine
    
  },
  Giusvalla: {
    link: "giusvalla", // parte variabile della URL
    link2: "meteo-giusvalla",
    lat: 44.448,            // latitudine
    lon: 8.394             // longitudine
    
  },
  Casanova: {
    link: "casanova", // parte variabile della URL
    link2: "meteo-casanova",
    lat: 44.375,            // latitudine
    lon: 8.574             // longitudine
    
  },
  CelleLigure: {
    link: "celle", // parte variabile della URL
    link2: "meteo-celle",
    lat: 44.343,            // latitudine
    lon: 8.545             // longitudine
    
  },
    Oregina: {
    link: "oregina", // parte variabile della URL
    link2: "meteo-oregina",
    lat: 44.424,            // latitudine
    lon: 8.927             // longitudine
    
  },
  MarassiFirpo: {
    link: "terzereti", // parte variabile della URL
    link2: "meteo-marassi-firpo",
    lat: 44.415,            // latitudine
    lon: 8.950             // longitudine
    
  },
  Cornigliano: {
    link: "cornigliano", // parte variabile della URL
    link2: "meteo-cornigliano",
    lat: 44.415,            // latitudine
    lon: 8.873             // longitudine
    
  },
  TramontanaSurfVoltri: {
    link: "voltri", // parte variabile della URL
    link2: "meteo-voltri",
    lat: 44.427,            // latitudine
    lon: 8.757             // longitudine
    
  },
  Albisola: {
    link: "albisola", // parte variabile della URL
    link2: "meteo-albisola",
    lat: 44.326,            // latitudine
    lon: 8.501             // longitudine
    
  },
  SavonaNautico: {
    link: "savona", // parte variabile della URL
    link2: "meteo-savona",
    lat: 44.308,            // latitudine
    lon: 8.487             // longitudine
    
  },
  Zinola: {
    link: "savona-zinola", // parte variabile della URL
    link2: "meteo-savona-zinola",
    lat: 44.282,            // latitudine
    lon: 8.443             // longitudine
    
  },
  Masone: {
    link: "savona-zinola", // parte variabile della URL
    link2: "meteo-masone-vallechiara",
    lat: 44.503,            // latitudine
    lon: 8.720             // longitudine
    
  },
  RossiglioneLIMET: {
    link: "savona-zinola", // parte variabile della URL
    link2: "meteo-rossiglione",
    lat: 44.560,            // latitudine
    lon: 8.672             // longitudine
    
  },
    RossiglioneLIMET: {
    link: "savona-zinola", // parte variabile della URL
    link2: "meteo-rossiglione",
    lat: 44.560,            // latitudine
    lon: 8.672             // longitudine
    
  },  LaTerza: {
    link: "savona-zinola", // parte variabile della URL
    link2: "meteo-rifugio-laterza",
    lat: 44.059,            // latitudine
    lon: 7.730             // longitudine
    
  }, Piaggia: {
    link: "savona-zinola", // parte variabile della URL
    link2: "meteo-piaggia",
    lat: 44.082,            // latitudine
    lon: 7.749             // longitudine
    
  }, 
  Bragalla: {
    link: "h", // parte variabile della URL
    link2: "meteo-bragalla",
    lat: 44.446,            // latitudine
    lon: 9.102             // longitudine
    
  },
  Caucaso: {
    link: "h", // parte variabile della URL
    link2: "meteo-caucaso",
    lat: 44.455,            // latitudine
    lon: 9.225             // longitudine
    
  },
  Rocca: {
    link: "h", // parte variabile della URL
    link2: "meteo-rocca",
    lat: 44.552,            // latitudine
    lon: 9.471             // longitudine
    
  },
  Oregin: {
    link: "h", // parte variabile della URL
    link2: "meteo-oregina",
    lat: 44.423,            // latitudine
    lon: 8.928             // longitudine
    
  },
};
// ----- Colori -----
const tempSections = [
  steelseries.Section(-50,-10, "#1c1f4a"),  // blu notte meno intenso
  steelseries.Section(-10,-5,  "#1a3bbf"),  // blu
  steelseries.Section(-5,0,    "#5a85a0"),  // azzurro-grigio
  steelseries.Section(0,5,     "#a0c4d4"),  // azzurro chiaro
  steelseries.Section(5,11,    "#2f4d2f"),  // verde scuro smorzato
  steelseries.Section(11,15,   "#5a8a3f"),  // verde più tenue
  steelseries.Section(15,20,   "#c0a840"),  // giallo-arancio smorzato
  steelseries.Section(20,25,   "#c07030"),  // arancio tenue
  steelseries.Section(25,30,   "#bf4040"),  // rosso smorzato
  steelseries.Section(30,35,   "#5c0c0c"),  // rosso scuro più tenue
  steelseries.Section(35,38,   "#c06ca0"),  // rosa smorzato
  steelseries.Section(38,50,   "#6b4bbc")   // viola meno intenso
];


// Umidità (%)
const humSections = [
  steelseries.Section(0,10,   "#F01E00"),
  steelseries.Section(10,20,  "#F07D00"),
  steelseries.Section(20,30,  "#F0CB00"),
  steelseries.Section(30,40,  "#F0B800"),
  steelseries.Section(40,50,  "#3AA300"),
  steelseries.Section(50,60,  "#21C573"),
  steelseries.Section(60,70,  "#21C2C5"),
  steelseries.Section(70,80,  "#00BDEF"),
  steelseries.Section(80,90,  "#0060F0"),
  steelseries.Section(90,100, "#0114F0")
];

// Pioggia (mm)
const rainSections = [
  steelseries.Section(0,0.2,   "#808080"),
  steelseries.Section(0.2,5,  "#F09F00"),
  steelseries.Section(5,10,   "#006400"),
  steelseries.Section(10,20,  "#3AA300"),
  steelseries.Section(20,30,  "#87CEEB"),
  steelseries.Section(30,50,  "#4682B4"),
  steelseries.Section(50,100, "#0038F0"),
  steelseries.Section(100,150,"#FF69B4"),
  steelseries.Section(150,500,"#843BEB")
];

// Vento (km/h) – esempio con tre intervalli
const windSections = [
  steelseries.Section(0,20,"#00BFFF"),
  steelseries.Section(20,50,"#00FF00"),
  steelseries.Section(50,100,"#FF0000")
];

// Pressione (hPa) – esempio con intervalli
const pressSections = [
  steelseries.Section(950,980,"#FF0000"),
  steelseries.Section(980,1010,"#00FF00"),
  steelseries.Section(1010,1055,"#0000FF")
];

function dynamicRange(value, buffer = 10, minLimit = null, maxLimit = null) {
  if (value === null || value === undefined || isNaN(value)) {
    return { min: minLimit ?? 0, max: maxLimit ?? 100 };
  }
  let min = Math.floor(value - buffer);
  let max = Math.ceil(value + buffer);

  // Applica limiti se definiti
  if (minLimit !== null) min = Math.max(min, minLimit);
  if (maxLimit !== null) max = Math.min(max, maxLimit);

  // Assicura gap minimo
  if (max - min < buffer * 2) {
    min = value - buffer;
    max = value + buffer;
    if (minLimit !== null) min = Math.max(min, minLimit);
    if (maxLimit !== null) max = Math.min(max, maxLimit);
  }

  return { min, max };
}
const tooltip = document.getElementById("gaugeTooltip");

function addGaugeTooltip(gauge, TempLow, TempHigh, current, label="Valori") {
  const canvas = gauge.canvas;

  canvas.addEventListener("mousemove", (e) => {
    const rect = canvas.getBoundingClientRect();
    tooltip.style.left = (e.clientX + 10) + "px";
    tooltip.style.top = (e.clientY + 10) + "px";
    tooltip.style.display = "block";
    tooltip.innerHTML = `
      ${label}<br>
      Massima: ${fmt1(TempHigh)}<br>
      Minima: ${fmt1(TempLow)}<br>
      Attuale: ${fmt1(current)}
    `;
  });

  canvas.addEventListener("mouseleave", () => {
    tooltip.style.display = "none";
  });
}

function updateGaugeWithDynamicScale(gauge, value, options = {}) {
  if (value === null || value === undefined) return;
  const range = dynamicRange(value, options.buffer ?? 10, options.min, options.max);
  gauge.setMinValue(range.min);
  gauge.setMaxValue(range.max);
  gauge.setValueAnimated(value);
}

// ----- CONFIGURAZIONE COMUNE GAUGES -----
const commonRadial = {
  gaugeType: steelseries.GaugeType.TYPE4,
  frameDesign: steelseries.FrameDesign.TILTED_GRAY,
  backgroundColor: steelseries.BackgroundColor.BEIGE,
  pointerVisible: false,
  ledVisible: false,
  lcdVisible: true,
  lcdDecimals: 1,
  tickLabelOrientation: steelseries.TickLabelOrientation.HORIZONTAL,
  niceScale: true
};

// Funzione helper per aggiornare colori dinamici
function setGaugeColor(gauge, value, type) {
  let color = "#000"; // colore di default
  switch(type) {
    case "hum": color = getColorHum(value); break;
    case "rain": color = getColorRain(value); break;
    case "temp": color = getColorTemp(value); break;
  }
  gauge.setLedColor(color);   // cambia colore LED
  gauge.setFrameColor(color); // cambia colore frame
  gauge.setSection([steelseries.Section(gauge.getMinValue(), gauge.getMaxValue(), color, 0.6)]);
}

// Esempio di aggiornamento valori:
function updateGauges(data) {
  if(data.hum !== null) {
    gRH.setValueAnimated(data.hum);
    setGaugeColor(gRH, data.hum, "hum");
  }
  if(data.rtot !== null) {
    gRain.setValueAnimated(data.rtot);
    setGaugeColor(gRain, data.rtot, "rain");
  }
  if(data.temp !== null) {
    gTemp.setValueAnimated(data.temp);
    setGaugeColor(gTemp, data.temp, "temp");
    addGaugeTooltip(gTemp, data.tempLow, data.tempHigh, temp, "Temperatura");
  }
  // ... altri gauges come prima
}

// ----- CREAZIONE GAUGES -----
const gTemp     = new steelseries.Radial("g_temp",     { ...commonRadial, minValue:-20, maxValue:50, titleString:"TEMPERATURA", unitString:"°C", section: tempSections });
const gDew      = new steelseries.Radial("g_dew",      { ...commonRadial, minValue:-20, maxValue:30, titleString:"DEW POINT", unitString:"°C", section: tempSections });
const gRH       = new steelseries.Radial("g_rh",       { ...commonRadial, minValue:0, maxValue:100, titleString:"UMIDITÀ", unitString:"%", section: humSections });
const gPress    = new steelseries.Radial("g_press",    { ...commonRadial, minValue:950, maxValue:1055, titleString:"PRESSIONE", unitString:"hPa", section: pressSections });
const gWind     = new steelseries.Radial("g_wind",     { ...commonRadial, minValue:0, maxValue:100, titleString:"VELOCITÀ VENTO", unitString:"km/h", section: windSections });
const gRain     = new steelseries.RadialBargraph("g_rain", { minValue:0, maxValue:1000, titleString:"PIOGGIA TOTALE", unitString:"mm", frameDesign:steelseries.FrameDesign.TILTED_GRAY, backgroundColor:steelseries.BackgroundColor.BEIGE, lcdVisible:true, lcdDecimals:1, ledVisible:false, niceScale:true, section: rainSections });
const gRainRate = new steelseries.Radial("g_rainrate", { ...commonRadial, minValue:0, maxValue:1000, titleString:"RAIN RATE", unitString:"mm/h", section: rainSections });

function updateGauges(data) {
  const temp = data.temp ?? null;
  const dewpt = data.dewp ?? null;
  const rh = data.hum ?? null;
  const pres = data.pres ?? null;
  const ws = data.wind ?? null;
  const gust = data.windGust ?? null;
  const wdir = data.windDir ?? null;
  const rtot = data.rainDaily ?? data.rtot ?? null;
  const rrate = data.rainRate ?? data.rrate ?? null;

  // Temperature e dew point: scala dinamica
  if (temp !== null) updateGaugeWithDynamicScale(gTemp, temp, { buffer: 15 });
  if (dewpt !== null) updateGaugeWithDynamicScale(gDew, dewpt, { buffer: 10 });

  // Umidità: scala 0-100
  if (rh !== null) updateGaugeWithDynamicScale(gRH, rh, { min: 0, max: 100 });

  // Pressione: scala dinamica ±15 hPa
  if (pres !== null) updateGaugeWithDynamicScale(gPress, pres, { buffer: 15 });

  // Vento e raffica → range dinamico ma ampiezza max 30
  if (ws !== null) {
    const min = Math.max(0, Math.floor(ws - 15));
    const max = Math.ceil(ws + 15);
    gWind.setMinValue(min);
    gWind.setMaxValue(max);
    gWind.setValueAnimated(ws);
  }
  if (gust !== null) {
    const min = Math.max(0, Math.floor(gust - 15));
    const max = Math.ceil(gust + 15);
    gWind.setMinValue(min);
    gWind.setMaxValue(max);
    gWind.setValueAnimated(gust);
  }

  // Pioggia totale → minimo 0, scala dinamica
  if (rtot !== null) updateGaugeWithDynamicScale(gRain, rtot, { min: 0 });

  // Rain rate → range dinamico ma ampiezza max 100
  if (rrate !== null) {
    const min = Math.max(0, Math.floor(rrate - 50));
    const max = Math.ceil(rrate + 50);
    gRainRate.setMinValue(min);
    gRainRate.setMaxValue(max);
    gRainRate.setValueAnimated(rrate);
  }


  // Aggiornamento testo
  setText("dewpt", fmt1(dewpt));
  setText("feels", fmt1(data.heat ?? temp));
  setText("rh_txt", fmt1(rh));
  setText("uv", data.uv ?? "—");
  setText("p_txt", fmt1(pres));
  setText("ptrend", data.pTrend ?? "—");
  setText("gust", fmt1(gust));
  setText("wdir", fmt1(wdir));
  setText("rtotal", fmt1(rtot));
}


// --- FETCH FUNZIONI ---
async function fetchTorinoMeteo() {
  try {
    const url = "https://www.torinometeo.org/api/v1/realtime/data/?format=json";
    const res = await fetch(url);
    const data = await res.json();

    if (!Array.isArray(data)) throw new Error("Risposta TorinoMeteo inattesa");

    // Cerca la stazione corrispondente allo stationId scelto
    const stationData = data.find(st => st.station?.slug === stationId);
    if (!stationData) throw new Error("Stazione TorinoMeteo non trovata");

    const st = stationData.station;

    // Parsing sicuro dei valori
    const temp      = stationData.temperature        != null ? parseFloat(stationData.temperature)     : null;
    const tempHigh  = stationData.temperature_max    != null ? parseFloat(stationData.temperature_max) : null;
    const tempLow   = stationData.temperature_min    != null ? parseFloat(stationData.temperature_min) : null;

    const hum       = stationData.relative_humidity  != null ? parseFloat(stationData.relative_humidity)     : null;
    const humHigh   = stationData.relative_humidity_max != null ? parseFloat(stationData.relative_humidity_max) : null;
    const humLow    = stationData.relative_humidity_min != null ? parseFloat(stationData.relative_humidity_min) : null;

    const dewp      = stationData.dewpoint           != null ? parseFloat(stationData.dewpoint)     : null;
    const dewpHigh  = stationData.dewpoint_max       != null ? parseFloat(stationData.dewpoint_max) : null;
    const dewpLow   = stationData.dewpoint_min       != null ? parseFloat(stationData.dewpoint_min) : null;

    const wind      = stationData.wind_strength      != null ? parseFloat(stationData.wind_strength)     : null;
    const windGust  = stationData.wind_strength_max  != null ? parseFloat(stationData.wind_strength_max) : null;
    const windDir   = stationData.wind_dir           != null ? parseFloat(stationData.wind_dir)          : null;

    const rainDaily = stationData.rain               != null ? parseFloat(stationData.rain)      : null; // totale caduto
    const rainRate  = stationData.rain_rate          != null ? parseFloat(stationData.rain_rate) : null; // intensità

    // Aggiorna gauges
    updateGauges({
      source: "TorinoMeteo",
      temp, tempHigh, tempLow,
      hum, humHigh, humLow,
      dewp, dewpHigh, dewpLow,
      wind, windGust, windDir,
      rainDaily, rainRate
    });


    $("updated").textContent = "Ultimo aggiornamento: "+new Date().toLocaleString();
  }catch(e){ console.error(e); $("updated").textContent="Errore: "+e.message; }
}
async function fetchCML() {
  try {
    const url = "https://corsproxy.io/?" + encodeURIComponent(
      "http://www.centrometeolombardo.com/Moduli/refx.php?t=all&r=" + Date.now()
    );

    const res = await fetch(url);
    const text = await res.text();

    // helper per parsare numeri in modo sicuro
    const parseNum = (v) => {
      if (v === null || v === undefined) return null;
      const n = parseFloat(String(v).replace(",", "."));
      return Number.isFinite(n) ? n : null;
    };

    // estrai coords (usata solo per trovare l'indice corrispondente all'id)
    const matchCoords = text.match(/var coords\s*=\s*(\[\[[\s\S]*?\]\]);/);
    if (!matchCoords) throw new Error("Coords non trovati nel contenuto CML");
    const coords = JSON.parse(matchCoords[1].replace(/'/g, '"'));

    // estrai datostazione
    const matchData = text.match(/datostazione\s*=\s*(\[\[[\s\S]*?\]\]);/);
    if (!matchData) throw new Error("datostazione non trovati nel contenuto CML");
    const datostazione = JSON.parse(matchData[1].replace(/'/g, '"'));

    // trova l'indice della stationId (coords[i][0] contiene l'ID della stazione)
    const idx = coords.findIndex(c => String(c[0]).toLowerCase() === String(stationId).toLowerCase());
    if (idx === -1) throw new Error("Stazione non trovata in CML: " + stationId);

    const row = datostazione[idx];
    if (!Array.isArray(row)) throw new Error("Riga datostazione non valida per indice: " + idx);

    // se row[0] === '1' allora è inattiva (come in codice precedente)
    if (row[0] === "1") {
      updateGauges({
        source: "CML",
        temp: null,
        tempHigh: null,
        tempLow: null,
        dewp: null,
        dewpHigh: null,
        dewpLow: null,
        hum: null,
        humHigh: null,
        humLow: null,
        rainDaily: null,
        rainRate: null,
        wind: null,
        windGust: null,
        windGustHigh: null,
        windDir: null,
        // tolte le coordinate come richiesto
        isInactive: true
      });
    } else {
      // mappatura valori (index come nel tuo array originale)
      const temp      = parseNum(row[4]);
      const tempHigh  = parseNum(row[5]);
      const tempLow   = parseNum(row[7]);
      const dewp      = parseNum(row[15]);
      const dewpHigh  = parseNum(row[16]);
      const dewpLow   = parseNum(row[18]);
      const hum       = parseNum(row[9]);
      const humHigh   = parseNum(row[10]);
      const humLow    = parseNum(row[12]);
      const rainDaily = parseNum(row[37]); // attenzione: potrebbe non esistere sempre
      const rainRate  = parseNum(row[41]); // attenzione: potrebbe non esistere sempre
      const wind      = parseNum(row[28]);
      const windGust  = parseNum(row[25]);
      const windGustHigh = parseNum(row[26]);
      const windDir   = (row[29] !== undefined && row[29] !== null && row[29] !== "") ? (isNaN(Number(row[29])) ? row[29] : parseNum(row[29])) : null;

      updateGauges({
        source: "CML",
        temp,
        tempHigh,
        tempLow,
        dewp,
        dewpHigh,
        dewpLow,
        hum,
        humHigh,
        humLow,
        rainDaily,
        rainRate,
        wind,
        windGust,
        windGustHigh,
        windDir,
        // non invio lat/lon (togliendo la parte delle coordinate)
        isInactive: false
      });
    }

    $("updated").textContent = "Ultimo aggiornamento: " + new Date().toLocaleString();

  } catch (err) {
    console.error("Errore fetch CML:", err);
    $("updated").textContent = "Errore CML: " + err.message;
  }
}



async function fetchMeteoTortona(id) {
  const st = stationsMeteoTortona[stationId];
if (!st || !st.link) {
  console.error("Stazione MeteoTortona non trovata:", stationId);
  $("updated").textContent = "Errore: stazione non trovata";
  return;
}

try {
  const url = "https://corsproxy.io/?" + encodeURIComponent(st.link);
  const res = await fetch(url);
  const text = await res.text();

  // Temperatura
  const tempMatch = text.match(/Temperatura<\/div>[\s\S]*?<h1>([\d.]+) &deg;C<\/h1>/);
  const temp = tempMatch ? parseFloat(tempMatch[1]) : null;

  // Umidità
  const humMatch = text.match(/Umidit &agrave;<\/div>[\s\S]*?<h1>([\d.]+) &#37;<\/h1>/);
  const hum = humMatch ? parseFloat(humMatch[1]) : null;

  // Vento
  const windMatch = text.match(/Vento<\/div>[\s\S]*?<h1>([\d.]+) Km\/h ([NSEW]+)<\/h1>/);
  const wind = windMatch ? parseFloat(windMatch[1]) : null;
  const windDirRaw = windMatch ? windMatch[2] : null;
  const dirMap = { N:0, NE:45, E:90, SE:135, S:180, SW:225, W:270, NW:315 };
  const windDir = windDirRaw && dirMap[windDirRaw.toUpperCase()] !== undefined ? dirMap[windDirRaw.toUpperCase()] : null;

  // Raffica
  const gustMatch = text.match(/Raffica<\/div>[\s\S]*?<h1>([\d.]+) Km\/h<\/h1>/);
  const gust = gustMatch ? parseFloat(gustMatch[1]) : null;

  // Pioggia giornaliera
  const rainMatch = text.match(/Precipitazioni<\/div>[\s\S]*?<h1>([\d.]+) mm<\/h1>/);
  const rainDaily = rainMatch ? parseFloat(rainMatch[1]) : null;

  // Pioggia totale (mese/anno se disponibile)
  const rainMonthMatch = text.match(/Mese<\/div>[\s\S]*?<h1>([\d.]+) mm<\/h1>/);
  const rainMonth = rainMonthMatch ? parseFloat(rainMonthMatch[1]) : null;

  const rainYearMatch = text.match(/Anno<\/div>[\s\S]*?<h1>([\d.]+) mm<\/h1>/);
  const rainYear = rainYearMatch ? parseFloat(rainYearMatch[1]) : null;

  // Pressione
  const pressMatch = text.match(/Pressione<\/div>[\s\S]*?<h1>([\d.]+) hPa<\/h1>/);
  const pressure = pressMatch ? parseFloat(pressMatch[1]) : null;

  // Dew point
  const dewMatch = text.match(/Dew Point<\/div>[\s\S]*?<h1>([\d.]+) &deg;C<\/h1>/);
  const dewPoint = dewMatch ? parseFloat(dewMatch[1]) : null;

  // Aggiorna i gauge
  updateGauges({
    source: "MeteoTortona",
    temp,
    hum,
    wind,
    windDir,
    gust,
    rainDaily,
    rainMonth,
    rainYear,
    pressure,
    dewPoint
  });

  $("updated").textContent = "Ultimo aggiornamento: " + new Date().toLocaleString();

} catch (err) {
  console.error(`Errore fetch stazione ${id}:`, err);
  $("updated").textContent = "Errore MeteoTortona: " + err.message;
}
}

async function fetchLimet(){
  try{
    if(!stationsLimet || !stationsLimet[stationId]) throw new Error("Stazione LIMET non definita");
    const link2 = stationsLimet[stationId].link2;
    const res = await fetch("https://api.allorigins.win/get?url="+encodeURIComponent(`https://retelimet.centrometeoligure.it/stazioni/${link2}/data/cu/realtimegauges.txt`));
    const json = await res.json();
    const data = JSON.parse(json.contents);

    updateGauges({
      source:"Limet",
      temp: parseFloat(data.temp.replace(",", ".")) || null,
      tempHigh: parseFloat(data.tempTH.replace(",", ".")) || null,
      tempLow: parseFloat(data.tempTL.replace(",", ".")) || null,
      dewp: parseFloat(data.dew.replace(",", ".")) || null,
      heat: parseFloat(data.heatindex.replace(",", ".")) || null,
      hum: parseFloat(data.hum.replace(",", ".")) || null,
      wind: parseFloat(data.wspeed.replace(",", ".")) || null,
      windGust: parseFloat(data.wgust.replace(",", ".")) || null,
      windDir: parseFloat(data.bearing.replace(",", ".")) || null,
      rtot: parseFloat(data.rfall.replace(",", ".")) || null,
      rrate: parseFloat(data.rrate.replace(",", ".")) || null
    });
    $("updated").textContent="Ultimo aggiornamento: "+new Date().toLocaleString();
  }catch(e){ console.error("Errore fetch LIMET:",e); $("updated").textContent="Errore LIMET: "+e.message; }
}

async function fetchOMIRL(){
  try{
    const fetchSensor = async(sensor)=>{ 
      const url="https://corsproxy.io/?"+encodeURIComponent(`https://omirl.regione.liguria.it/Omirl/rest/stations/sensorvalues/${sensor}`);
      const res = await fetch(url);
      return await res.json();
    };
    const [tempsData, windData, humData, rainData] = await Promise.all([fetchSensor("Termo"), fetchSensor("Vento"), fetchSensor("Igro"), fetchSensor("Pluvio")]);
    const tempEntry = tempsData.tableRows?.find(st=>st.code===stationId) || {};
    const windEntry = windData.tableRows?.find(st=>st.code===stationId) || {};
    const humEntry  = humData.tableRows?.find(st=>st.code===stationId) || {};
    const rainEntry = rainData.tableRows?.find(st=>st.code===stationId) || {};
    updateGauges({
      source:"OMIRL",
      temp: tempEntry.last!=null?parseFloat(tempEntry.last):null,
      tempHigh: tempEntry.max!=null?parseFloat(tempEntry.max):null,
      tempLow: tempEntry.min!=null?parseFloat(tempEntry.min):null,
      dewp:null,
      heat: tempEntry.last!=null?parseFloat(tempEntry.last):null,
      hum: humEntry.last!=null?parseFloat(humEntry.last):null,
      wind: windEntry.last!=null?parseFloat(windEntry.last):null,
      windGust: windEntry.max!=null?parseFloat(windEntry.max):null,
      windDir: windEntry.direction!=null?parseFloat(windEntry.direction):null,
      rtot: rainEntry.last!=null?parseFloat(rainEntry.last):null,
      rrate:null
    });
    $("updated").textContent="Ultimo aggiornamento: "+new Date().toLocaleString();
  }catch(e){ console.error("Errore fetch OMIRL:",e); $("updated").textContent="Errore OMIRL: "+e.message; }
}

// --- REFRESH ---
async function refresh(){
  switch(source.toLowerCase()){
    case "limet": await fetchLimet(); break;
    case "omirl": await fetchOMIRL(); break;
    case "torinometeo": await fetchTorinoMeteo(); break;
    case "centrometeolombardo": await fetchCML(); break;
    case "meteotortona": await fetchMeteoTortona(); break;
    case "meteo3R": await fetchMeteo3R(); break;
    default: await fetchWunderground();
  }
}

// primo caricamento + refresh automatico
refresh();
setInterval(refresh, REFRESH_MS);
</script>
</body>
</html>
