<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Dati stazioni CML</title>
  <style>
    body { font-family: monospace; font-size: 13px; margin: 10px; background: #fff; color: #000; }
    pre { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body>
  <pre id="output">Caricamento...</pre>

  <script>
    const REFRESH_INTERVAL = 30 * 1000; // 30 secondi
    const REMOTE = 'http://www.centrometeolombardo.com/Moduli/refx.php?t=all&r=1756559495232';
    const PROXY = 'https://corsproxy.io/?';

    function fittizioAReale(xFittizio, yFittizio) {
      const lon = ((8260 + xFittizio / 1.18) / 1000).toFixed(3);
      const lat = ((46730 - yFittizio / 1.72) / 1000).toFixed(3);
      return { lat, lon };
    }

    function formatTimestamp(date) {
      const pad = n => n.toString().padStart(2, '0');
      return `${pad(date.getDate())}/${pad(date.getMonth()+1)}/${date.getFullYear()} ` +
             `${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
    }

    async function updateData() {
      try {
        const res = await fetch(PROXY + encodeURIComponent(REMOTE));
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const text = await res.text();

        // estrai coords
        const matchCoords = text.match(/var coords\s*=\s*(\[\[[\s\S]*?\]\]);/);
        if (!matchCoords) throw new Error('Coords non trovati');
        const coords = JSON.parse(matchCoords[1].replace(/'/g, '"'));

        // estrai datostazione
        const matchData = text.match(/datostazione\s*=\s*(\[\[[\s\S]*?\]\]);/);
        if (!matchData) throw new Error('Dati stazioni non trovati');
        const datostazione = JSON.parse(matchData[1].replace(/'/g, '"'));

        const lines = [];
        // prima riga: timestamp
        lines.push(formatTimestamp(new Date()));

        for (let i = 0; i < coords.length; i++) {
          const c = coords[i];
          const row = datostazione[i] || [];
          const nome = (c[1] || c[0]).toString();
          const { lat, lon } = fittizioAReale(parseFloat(c[3]), parseFloat(c[4]));
          const isInactive = row[0] === '1' || row[0] === 1;

          const p = v => (v === null || v === undefined || v === '' ? 'null' : String(v));

          if (isInactive) {
            lines.push(`S:"1",N:"${nome}",T:"null",TH:"null",TL:"null",D:"null",DH:"null",DL:"null",H:"null",HH:"null",HL:"null",V:"null",G:"null",R:"null",RR:"null",LAT:"${p(lat)}",LON:"${p(lon)}"`);
          } else {
            lines.push(`S:"0",N:"${nome}",T:"${p(row[4])}",TH:"${p(row[5])}",TL:"${p(row[7])}",D:"${p(row[15])}",DH:"${p(row[16])}",DL:"${p(row[18])}",H:"${p(row[9])}",HH:"${p(row[10])}",HL:"${p(row[12])}",V:"${p(row[28])}",G:"${p(row[25])}",R:"${p(row[37])}",RR:"${p(row[41])}",LAT:"${p(lat)}",LON:"${p(lon)}"`);
          }
        }

        document.getElementById('output').textContent = lines.join("\n");
      } catch (err) {
        document.getElementById('output').textContent = 'Errore: ' + err.message;
        console.error(err);
      }
    }

    updateData();
    setInterval(updateData, REFRESH_INTERVAL);
  </script>
</body>
</html>
