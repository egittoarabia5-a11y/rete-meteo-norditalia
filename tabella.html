<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Tabella Stazioni Meteo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin: 0; font-family: "Inter", sans-serif; padding: 20px; background: #f5f5f5; }
    h1 { text-align: center; }
    
    /* Wrapper scrollabile orizzontale */
    .table-wrapper table {
  min-width: 2000px; /* aumenta in base al numero di colonne */
  table-layout: fixed; /* forza le colonne a rimanere nella tabella */
}
.table-wrapper {
  overflow-x: auto;
  width: 100%;
}


    table {
      border-collapse: collapse;
      min-width: 1500px; /* assicura che tutte le colonne entrino */
      width: max-content;
    }

    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #2563eb; color: white; position: sticky; top: 0; z-index: 2; }

    /* Intestazione fissa del timestamp */
    th:first-child {
      left: 0;
      z-index: 3;
    }
    td:first-child {
      position: sticky;
      left: 0;
      background: #f5f5f5;
      z-index: 1;
    }
  </style>
</head>
<body>
  <h1>Temperatura Stazioni Meteo</h1>

  <div class="table-wrapper">
    <table id="tempTable">
      <thead>
        <tr id="headerRow">
            <th>Timestamp</th>
            <th>GE Gavette</th>
            <th>GE Sturla</th>
            <th>GE Boccadasse</th>
            <th>GE Albaro</th>
            <th>Ge Carignano</th>
            <th>Ge Brignole</th>
            <th>Ge S.Fruttuoso</th>
            <th>Ge Quezzi Bassa</th>
            <th>Ge Quezzi Alta</th>
            <th>Ge De Stefanis</th>
            <th>Ge Marassi</th>
            <th>Ge S.Gottardo</th>
            <th>Ge Molassana</th>
            <th>Ge Struppa</th>
            <th>Ge S.Colombano</th>
            <th>Ge S.Eusebio</th>
            <th>Davagna</th>
            <th>Bargagli</th>
            <th>Ge S.Desiderio</th>
            <th>Ge S.Ilario</th>
            <th>Ge Nervi</th>
            <th>Ge Commercio</th>
            <th>Ge Murcarolo</th>
            <th>Ge Quinto</th>
            <th>Ge Colle Ometti</th>
            <th>Ge Quarto Alta</th>
        </tr>
    </thead>
    <tbody id="tableBody"></tbody>
</table>
</div>

<a href="index.html" style="display:block; margin-top:20px; text-align:center; color:#2563eb;">← Torna alla mappa</a>

<script>
  const apiKey = 'e1f10a1e78da46f5b10a1e78da96f525';
    const stations = { 
      "IGENOA2800": { api: "IGENOA2800" }, 
      "IGENOA3085": { api: "IGENOA3085" },
      "IGENOA3052": { api: "IGENOA3052" },
      "IGENOA2980": { api: "IGENOA2980" },
      "IGENOA2895": { api: "IGENOA2895" },
      "IGENOA3035": { api: "IGENOA3035" },
      "IGENOA3078": { api: "IGENOA3078" },
      "IGENOA2991": { api: "IGENOA2991" },
      "ILIGURIA2": { api: "ILIGURIA2" },
      "IGENOA2819": { api: "IGENOA2819" },
      "IGENOA2843": { api: "IGENOA2843" },
      "IGENOA2987": { api: "IGENOA2987" },
      "IGENOA2767": { api: "IGENOA2767" },
      "IGENOA2846": { api: "IGENOA2846" },
      "IGENOA3032": { api: "IGENOA3032" },
      "IGENOA2933": { api: "IGENOA2933" },
      "IDAVAG2": { api: "IDAVAG2" },
      "IBARGAGL5": { api: "IBARGAGL5" },
      "IGENOVAN1": { api: "IGENOVAN1" },
      "IGENOA2983": { api: "IGENOA2983" },
      "IGENOA2971": { api: "IGENOA2971" },
      "IGENOA2997": { api: "IGENOA2997" },
      "IGENOA2887": { api: "IGENOA2887" },
      "IGENOA3104": { api: "IGENOA3104" },
    };
    const tbody = document.getElementById("tableBody");
    const storageKey = "meteoData";
    const maxRows = 50;

    function getTempColor(temp) {
      if (temp >= 38.0) return "#843BEB";
      if (temp >= 35.0) return "#FF69B4";
      if (temp >= 30.0) return "#8B0000";
      if (temp >= 25.0) return "#FF0000";
      if (temp >= 20.0) return "#E67D00";
      if (temp >= 15.0) return "#E6B800";
      if (temp >= 11.0) return "#3AA300";
      if (temp >= 5.0) return "#006400";
      if (temp >= 0.0) return "#87CEEB";
      if (temp >= -5.0) return "#4682B4";
      if (temp >= -10.0) return "#0000FF";
      return "#191970";
    }

    function getRoundedTimestamp() {
      const now = new Date();
      const minutes = Math.floor(now.getMinutes() / 10) * 10;
      now.setMinutes(minutes);
      now.setSeconds(0);
      now.setMilliseconds(0);
      return now.toISOString().replace("T", " ").slice(0,16);
    }

    function loadTable() {
      const saved = JSON.parse(localStorage.getItem(storageKey) || "[]");
      saved.forEach(entry => {
        const tr = document.createElement("tr");
        tr.dataset.ts = entry.timestamp;

        const tdTime = document.createElement("td");
        tdTime.textContent = entry.timestamp;
        tr.appendChild(tdTime);

        Object.keys(stations).forEach(st => {
          const td = document.createElement("td");
          const temp = entry[st];
          td.textContent = temp != null ? temp + " °C" : "-";
          td.style.backgroundColor = temp != null ? getTempColor(temp) : "";
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });
    }

    function saveRow(entry) {
      let saved = JSON.parse(localStorage.getItem(storageKey) || "[]");
      saved.push(entry);
      if (saved.length > maxRows) saved = saved.slice(saved.length - maxRows);
      localStorage.setItem(storageKey, JSON.stringify(saved));
    }

    async function fetchAllStations() {
      const timestamp = getRoundedTimestamp();
      const saved = JSON.parse(localStorage.getItem(storageKey) || "[]");
      if (saved.some(entry => entry.timestamp === timestamp)) return;

      const rowData = { timestamp };

      try {
        for (const st in stations) {
          const urlCurrent = `https://api.weather.com/v2/pws/observations/current?apiKey=${apiKey}&stationId=${stations[st].api}&numericPrecision=decimal&format=json&units=m`;
          const res = await fetch(urlCurrent);
          const data = await res.json();
          rowData[st] = data.observations[0].metric.temp;
        }

        const tr = document.createElement("tr");
        tr.dataset.ts = timestamp;

        const tdTime = document.createElement("td");
        tdTime.textContent = timestamp;
        tr.appendChild(tdTime);

        Object.keys(stations).forEach(st => {
          const td = document.createElement("td");
          const temp = rowData[st];
          td.textContent = temp != null ? temp + " °C" : "-";
          td.style.backgroundColor = temp != null ? getTempColor(temp) : "";
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
        saveRow(rowData);

      } catch(err) {
        console.error("Errore fetch:", err);
      }
    }

    loadTable();

    function scheduleNextFetch() {
      const now = new Date();
      const minutes = now.getMinutes();
      const msToNext10Min = (10 - (minutes % 10)) * 60 * 1000 - now.getSeconds()*1000 - now.getMilliseconds();

      setTimeout(async () => {
        await fetchAllStations();
        scheduleNextFetch();
      }, msToNext10Min);
    }

    fetchAllStations();
    scheduleNextFetch();
  </script>
</body>
</html>


